<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Incendios en Galicia ‚Äî StoryMap</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800;900&display=swap" rel="stylesheet">
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/scrollama"></script>
  <script>
    /* Fijar --vh en m√≥vil para evitar ‚Äúzoom‚Äù del hero al hacer scroll.
       No actualizamos en scroll; solo en carga y cambio de orientaci√≥n. */
    (function(){
      function setVH(){
        var vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', vh + 'px');
      }
      if (window.matchMedia('(max-width: 768px)').matches) {
        setVH();
        window.addEventListener('orientationchange', function(){
          // Ajustar tras cambiar orientaci√≥n
          setTimeout(setVH, 200);
        }, { passive: true });
      }
    })();
  </script>
  <style>
    :root{
      --ink:#ffffff;
      --panel:#041138;
      --glass-bg: rgba(25,25,25,0.55);
      --glass-brd: rgba(255,255,255,0.08);
    }

    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:#0b0b0b}

    /* Mapa fijo detr√°s */
    #map{position:fixed;inset:0;width:100vw;height:100vh}

/* Topbar estilo ‚Äúcabecera editorial‚Äù */
#topbar{
  position:fixed; 
  top:0; left:0; right:0; 
  height:56px;
  background: rgba(4, 17, 56, 0.95);
  backdrop-filter: blur(4px);
  display:flex; 
  align-items:center; 
  z-index:10;
  padding:0 16px; 
  border-bottom:1px solid #041138;
  transition: transform .28s ease, background-color .2s ease, height .2s ease, padding .2s ease;
  will-change: transform;
}

/* Unificamos fuente y peso */
#brand, #titleRight{
  font-weight:700; 
  letter-spacing:.2px;
  font-family: inherit;
}

/* Mandamos la descripci√≥n a la derecha */
#titleRight{
  margin-left:auto;
}


#spacer{ display:none; }

/* HERO  */
#hero{
  position:relative; z-index:9;
  min-height:100vh; width:100%;
  display:flex; flex-direction:column;
  justify-content:flex-start;   /* subimos el contenido */
  align-items:center;
  padding-top:25vh;             /* tercio superior - regla de los tercios */
  background-image: url('./assets/Imagen_quemado.webp');
  background-size:cover; 
  background-position:center center; /* Focal point centrado - zona m√°s contrastada */
  background-attachment: fixed; /* Efecto parallax en desktop */
  box-shadow: inset 0 -200px 200px rgba(0,0,0,.35);
}

/* Overlay din√°mico con degradado para mejorar contraste del t√≠tulo */
#hero::before{
  content: '';
  position: absolute;
  inset: 0;
  /* Degradado lineal vertical m√°s intenso arriba, suave abajo */
  background: linear-gradient(
    to bottom, 
    rgba(0,0,0,0.65) 0%, 
    rgba(0,0,0,0.55) 15%, 
    rgba(0,0,0,0.45) 30%, 
    rgba(0,0,0,0.3) 50%, 
    rgba(0,0,0,0.15) 70%, 
    transparent 100%
  );
  z-index: 1;
  pointer-events: none; /* permite interacci√≥n con elementos debajo */
}

/* Degradado radial din√°mico en la zona central para destacar el t√≠tulo */
#hero::after{
  content: '';
  position: absolute;
  inset: 0;
  /* Overlay radial m√°s intenso en el centro donde est√° el t√≠tulo */
  background: radial-gradient(
    ellipse 90% 60% at center 35%, 
    rgba(0,0,0,0.3) 0%, 
    rgba(0,0,0,0.2) 40%, 
    rgba(0,0,0,0.1) 60%, 
    transparent 80%
  );
  z-index: 1;
  pointer-events: none;
}

/* Asegurar que el contenido est√© por encima del overlay */
#hero .hero-inner {
  position: relative;
  z-index: 2;
}

/* Asegurar que los elementos absolutos tambi√©n est√©n por encima del overlay */
#hero .scroll-hint,
#hero .photo-credit {
  position: absolute;
  z-index: 2;
}

.hero-inner{
  width:min(1100px,92vw);
  margin-top:500;  
}

/* Animaci√≥n fade-in cinematogr√°fica */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Animaci√≥n de la flecha - movimiento suave arriba/abajo */
@keyframes bounceArrow {
  0%, 100% {
    transform: translateY(0);
  }
  50% {
    transform: translateY(3px);
  }
}

/* Vaiv√©n del bloque de scroll-hint (mantiene translateX(-50%)) */
@keyframes bounceHint {
  0%, 100% { transform: translateX(-50%) translateY(0); }
  50% { transform: translateX(-50%) translateY(3px); }
}

.hero-headline{
  font-family: 'Montserrat', system-ui, -apple-system, sans-serif;
  font-size: clamp(2.2rem, 6vw, 4.5rem);
  line-height: 1.1;
  font-weight: 800;
  text-align:center;
  text-shadow: 0 6px 30px rgba(0,0,0,.45);
  margin:0;
  letter-spacing: -0.02em; /* ligero ajuste para mejor legibilidad */
  /* Fade-in cinematogr√°fico al cargar */
  animation: fadeInUp 0.8s ease-out;
  opacity: 0;
  animation-fill-mode: forwards;
}

/* Ajustes para m√≥vil */
@media (max-width: 768px) {
  /* T√≠tulo m√°s arriba en m√≥vil */
  #hero {
    /* Altura fija basada solo en --vh para evitar cambios en Brave/iOS */
    height: calc(var(--vh, 1vh) * 100);
    min-height: calc(var(--vh, 1vh) * 100);
    padding-top: calc(var(--vh, 1vh) * 8);
    padding-bottom: 0;
    justify-content: flex-start;
    align-items: stretch; /* Para que los hijos puedan ocupar todo el ancho */
    /* Versi√≥n recortada vertical - centrada en zona m√°s contrastada */
    background-position: center 40%; /* Focal point ajustado para m√≥vil */
    background-size: cover;
    background-attachment: scroll !important; /* Sin parallax en m√≥vil para mejor rendimiento */
  }
  
  /* Topbar m√°s compacto y auto-ocultable en m√≥vil */
  #topbar{
    height: 44px;
    padding: 0.4rem 1rem;
    background: rgba(4, 17, 56, 0.95);
  }
  .topbar-hide{
    transform: translateY(-100%);
  }
  
  /* Overlay din√°mico ajustado para m√≥vil - m√°s intenso en la zona del t√≠tulo */
  #hero::before {
    background: linear-gradient(
      to bottom, 
      rgba(0,0,0,0.7) 0%, 
      rgba(0,0,0,0.6) 20%, 
      rgba(0,0,0,0.5) 35%, 
      rgba(0,0,0,0.3) 55%, 
      rgba(0,0,0,0.15) 75%, 
      transparent 100%
    );
  }
  
  /* Overlay radial m√°s concentrado en m√≥vil */
  #hero::after {
    background: radial-gradient(
      ellipse 85% 50% at center 30%, 
      rgba(0,0,0,0.35) 0%, 
      rgba(0,0,0,0.25) 35%, 
      rgba(0,0,0,0.15) 55%, 
      transparent 75%
    );
  }
  
  /* Distribuci√≥n ajustada para contenedor m√°s abajo y m√°s alto */
  .hero-inner {
    margin-top: 0;
    display: flex;
    flex-direction: column;
    align-items: stretch; /* Para que el contenedor pueda ser ancho completo */
    width: 100%;
    padding: 0; /* Sin padding lateral para que el contenedor sea ancho completo */
    min-height: auto;
    justify-content: flex-start;
  }
  
  .hero-headline {
    font-size: clamp(2.2rem, 6vw, 4.5rem);
    line-height: 1.2;
    margin: calc(var(--vh, 1vh) * 24) 0 3rem 0 !important; /* solo t√≠tulo */
    width: 100%;
  }
  
  /* Texto m√°s abajo, m√°s alto, ancho completo - m√≥vil */
  .hero-kicker {
    position: absolute;
    top: calc(var(--vh, 1vh) * 55); /* Posicionado m√°s abajo */
    left: 0 !important;
    right: 0 !important;
    margin: 0 !important; /* Sin margen */
    width: 100vw !important; /* Ancho completo de la pantalla */
    max-width: 100vw !important; /* Sin limitaci√≥n de ancho */
    min-width: 100vw !important; /* Forzar ancho m√≠nimo */
    max-height: none; /* Sin limitaci√≥n de altura, que quepa todo */
    height: auto; /* Altura autom√°tica para que quepa todo */
    border-radius: 0; /* Sin bordes redondeados */
    padding: 1rem 0.5rem !important; /* Padding lateral m√≠nimo */
    font-size: clamp(1.35rem, 4.5vw, 1.75rem); /* Letra a√∫n m√°s grande */
    line-height: 1.5; /* Interlineado ajustado */
    overflow-y: visible; /* Sin scroll, que se vea todo */
    z-index: 3; /* Por encima del overlay */
    box-sizing: border-box; /* Incluir padding en el ancho */
  }
  
  /* P√°rrafo √∫nico centrado en m√≥vil */
  .hero-kicker {
    text-align: center; /* Centrado tambi√©n en m√≥vil */
  }
  
  .hero-kicker p {
    margin: 0; /* Sin margen */
  }
  
  /* Salto de l√≠nea despu√©s del punto en m√≥vil */
  .hero-kicker .mobile-break::before {
    content: '\A'; /* Salto de l√≠nea */
    white-space: pre; /* Preservar espacios y saltos */
  }
  
  /* Sin margen extra: la grid ya crea la pausa visual */
  .hero-inner .hero-headline { margin-bottom: 0; }
  
  /* Asegurar que la fuente sea visible - sin container, m√°s en la esquina */
  .photo-credit {
    font-size: 10px;
    bottom: 8px;
    right: 8px;
    z-index: 12;
    background: transparent;
    padding: 0;
    border-radius: 0;
    backdrop-filter: none;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8), 0 1px 3px rgba(0, 0, 0, 0.9);
  }
  
  .scroll-hint {
    bottom: 50px;
    font-size: 12px;
  }
}

.hero-kicker{
  width:min(900px, 95vw); /* M√°s ancho para ser alargado */
  max-width: 60ch; /* M√°s estrecho - estilo Saving the Nile */
  margin:40px auto 0 auto;  
  background: rgba(4, 17, 56, 0.95); /* M√°s oscuro para compensar transparencia */
  color:#fff; 
  border-radius: 0; /* Sin bordes redondeados */
  font-size: clamp(1rem, 2.5vw, 1.4rem);
  padding: 0.8rem 0.9rem; /* Padding lateral m√≠nimo para que el texto ocupe m√°ximo espacio */
  line-height: 1.4; /* Letra m√°s pegada - menos interlineado */
  box-shadow: 0 8px 26px rgba(0,0,0,.35);
  text-align:center; /* Centrado */
  /* Fade-in cinematogr√°fico al cargar - con delay para secuencia */
  animation: fadeInUp 0.8s ease-out 0.2s;
  opacity: 0;
  animation-fill-mode: forwards;
}

/* P√°rrafo √∫nico centrado */
.hero-kicker p {
  margin: 0; /* Sin margen ya que es un solo p√°rrafo */
}

/* Espaciado entre t√≠tulo y primer p√°rrafo - pausa visual */
.hero-inner .hero-headline {
  margin-bottom: 2.5rem; /* Pausa visual despu√©s del t√≠tulo */
}



    /* Animaci√≥n fade-in espec√≠fica para scroll-hint con opacidad 70% */
    @keyframes fadeInUpHint {
      from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
      }
      to {
        opacity: 0.7;
        transform: translateX(-50%) translateY(0);
      }
    }
    
    /* Indicador de scroll */
    .scroll-hint{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:28px; font-size:13px;
      background:rgba(0,0,0,.5); padding:6px 10px; border-radius:16px;
      border:1px solid rgba(255,255,255,.08);
      /* Fade-in y vaiv√©n suave del bloque completo */
      animation: fadeInUpHint 0.8s ease-out 0.4s forwards, bounceHint 1.5s ease-in-out 1.2s infinite;
      opacity: 0;
    }
    
    /* Animaci√≥n de la flecha - movimiento suave arriba/abajo */
    .scroll-hint::after {
      content: ' ‚Üì';
      display: inline-block;
    }
    /* Cr√©ditos de foto y fuentes */
    .photo-credit, .map-source {
        font-size: 9px;
        color: rgba(255, 255, 255, 0.445);
        font-style: italic;
        pointer-events: none; /* no molesta a los clics */
        bottom: 10px;
    }
    .photo-credit {
        position: absolute;
        right: 14px;
        z-index: 11;
        color: rgba(255, 255, 255, 0.7);
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.8), 0 1px 3px rgba(0, 0, 0, 0.9);
    }
    .map-source {
        position: absolute;
        left: 100px;
        z-index: 3;  /* Por debajo del hero pero por encima del mapa */
    }
    .map-source.fixed {
        position: fixed;
    }



    /* Contenedor de la historia (cap√≠tulos) */
    #story{position:relative; z-index:5}
    #features{padding-top:30vh; padding-bottom:10vh}

    /* Tarjetas de cap√≠tulo (panel derecha) */
    .step{padding-bottom:45vh; opacity:.35}
    .step.active{opacity:.98}
    
    /* En m√≥vil: mismo comportamiento que escritorio para evitar saltos */
    @media (max-width: 768px){
      #features{ padding-top:30vh; padding-bottom:10vh }
      .step{ opacity:.35 }
      .step.active{ opacity:.98 }
    }
    
    /* Contenedor base del cap√≠tulo sin fondo espec√≠fico */
    .step > div.lefty, .step > div.righty, .step > div.centered, .step > div.fully {
      border-radius:12px; padding:18px 20px;
      line-height:1.45; font-size:14px; color:#f0f0f0;
    }
    
    /* Solo los p√°rrafos y encabezados obtienen el fondo opaco */
    .step h3, .step p,
    .layer-explanation {
      background: var(--glass-bg);
      border:1px solid var(--glass-brd);
      backdrop-filter: blur(4px);
      border-radius:8px; 
      padding:12px 16px;
      margin: 8px 0;
    }
    .layer-explanation{
      display:block;
    }
    h3{margin:0 0 8px 0; font-size:18px}


    .lefty {
      width: 33vw;
      margin-left: 5vw;
    }
    
    .righty {
      width: 57vw;
      margin-left: 38vw;
    }

    .fully {
      width: 90vw;
      margin-left: 5vw;
    }

    #galicia-noroeste.step::after{
      content:'';
      display:block;
      height:0;
    }

    /* Nueva clase espec√≠fica para el cap√≠tulo de tendencias */
    .chapter-wide {
      width: 84vw !important;
      margin-left: 4vw !important;  /* mismo margen que .lefty */
      position: relative !important;
    }

    /* Ajustes espec√≠ficos para el cap√≠tulo ‚ÄúUn verano para reaccionar‚Äù en m√≥vil */
    @media (max-width: 768px){
      #incendios-2025 {
        /* Fondo de tarjetas m√°s opaco solo en este cap√≠tulo */
        --glass-bg: rgba(25,25,25,0.9);
        --glass-brd: rgba(255,255,255,0.18);
      }
      #incendios-2025 .lefty{
        /* Un poco m√°s ancho que el valor m√≥vil por defecto (90vw) */
        width: 96vw;
        margin: 0 auto;
        font-size: 16px; /* cuerpo m√°s grande en m√≥vil */
      }
    }

    @media (max-width: 1200px){  /* Ajustado el breakpoint para pantallas m√°s grandes */
      .lefty, .righty { 
        width: 90vw; 
        margin: 0 auto; 
      }
      #topbar{
        height:auto; 
        padding:10px 12px; 
        gap:8px; 
        align-items:flex-start
      }
      #spacer{display:none}
      #titleCenter{text-align:left}
      .hero-headline{margin-top:12vh}
    }
    /* Cap√≠tulo 2: intercalar explicaciones en m√≥vil */
    .mobile-expl{display:none;}
    .only-mobile{display:none;}
    .only-desktop{display:block;}
    /* Cap√≠tulo 2 (solo escritorio): compactar p√°rrafos */
    #tendencia-aumento p{
      margin: 1px 0;
      line-height: 1.32;
      padding: 4px 10px;
    }
    /* Cap√≠tulo 2 (solo escritorio): igualar altura del bloque de texto al primer gr√°fico */
    #tendencia-aumento .desktop-expl{
      height: 600px;
      display: block;
    }
    @media (max-width: 768px){
      .chapter2-flex{display:block !important;}
      .desktop-expl{display:none !important;}
      .mobile-expl{display:block;}
      .chapter2-flex iframe{width:100%;}
      .only-desktop{display:none !important;}
      .only-mobile{display:block !important;}
    }
    /* Cap√≠tulo 2: reducir altura de iframes en m√≥vil (-15%) */
    @media (max-width: 768px){
      #tendencia-aumento iframe{
        height: 510px !important;
      }
    }
    /* Reducir espacio entre p√°rrafos en m√≥vil */
    @media (max-width: 768px){
      .step p{
        margin: 4px 0 !important;
        line-height: 1.45 !important;
      }
    }
    /* Cap√≠tulo 2 (solo m√≥vil): a√∫n m√°s compacto */
    @media (max-width: 768px){
      #tendencia-aumento p{
        margin: 1px 0 !important;
        line-height: 1.3 !important;
      }
    }
    /* Ancho global de contenedores en m√≥vil */
    @media (max-width: 768px){
      .step > div.lefty,
      .step > div.righty,
      .step > div.centered,
      .step > div.fully {
        width: 96vw;
        margin: 0 auto;
      }
    }
    /* Selector de categor√≠as */
    .category-selector-home{
        position: relative;
        width: 100%;
        z-index: 8;
    }
    .category-selector {
        position: fixed;
        top: 56px; /* Debajo del topbar */
        left: 0;
        right: 0;
        z-index: 8;
        display: none; /* Inicialmente oculto */
        justify-content: center;
        padding: 12px 20px;
        background: rgba(15, 23, 51, 0.85);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .category-tabs {
        display: flex;
        gap: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        padding: 4px;
    }

    .category-tab {
        padding: 10px 20px;
        background: transparent;
        color: rgba(255, 255, 255, 0.7);
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .category-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
    }

    .category-tab[aria-pressed="true"] {
        background: rgba(73, 123, 179, 0.9);
        color: white;
        box-shadow: 0 2px 8px rgba(73, 123, 179, 0.3);
    }

    .category-tab:focus {
        outline: 2px solid rgba(73, 123, 179, 0.8);
        outline-offset: 2px;
    }



    /* Overlay de im√°genes de clima */
    .climate-images-overlay {
        position: fixed;
        top: 120px;
        right: 20px;
        width: 850px;
        max-height: calc(100vh - 140px);
        z-index: 7;
        background: rgba(15, 23, 51, 0.92);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        overflow-y: auto;
        transition: all 0.4s ease;
    }

    .climate-images-overlay.hidden {
        opacity: 0;
        visibility: hidden;
        transform: translateX(20px);
    }

    .climate-images-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-items: center;
    }

    .climate-images-container img {
        height: auto;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .climate-img-small {
        width: 100%;
        max-width: 400px;
    }

    .climate-img-large {
        width: 100%;
        max-width: 760px;
    }

    /* Contenedor inline para clima (solo m√≥vil) */
    .climate-inline{
        margin-top: 18px;
        padding: 0;
        background: transparent;
        border: none;
        border-radius: 0;
        box-shadow: none;
        display: none;
        gap: 14px;
        flex-direction: column;
    }
    .climate-inline img{
        width: 100%;
        height: auto;
        border-radius: 10px;
        object-fit: cover;
        box-shadow: 0 6px 18px rgba(0,0,0,0.35);
    }
    .climate-inline .climate-inline-small{
        width: 100%;
    }

    @media (min-width: 769px){
        .climate-inline{
            display: none !important;
        }
    }

    /* Responsive */
    @media (max-width: 768px) {
        .category-selector {
            padding: 8px 12px;
        }
        
        .category-tab {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .category-text-overlay {
            left: 12px;
            right: 12px;
            width: auto;
            top: 100px;
        }
        
        .climate-images-overlay {
            left: 12px;
            right: 12px;
            width: auto;
            top: 100px;
        }
        
        .climate-img-large {
            max-width: 100%;
        }
        
        .climate-img-small {
            max-width: 70%;
        }
        
        .climate-images-container {
            gap: 12px;
        }
        
        .climate-images-container img {
            max-width: 80%;
        }
        
        #galicia-noroeste #layer-explanation{
            margin-top: 12px !important;
            padding: 12px 14px !important;
        }
        
        #galicia-noroeste.step{
            padding-bottom: 44vh;
        }
        #galicia-noroeste.step::after{
            height: 6vh;
        }
        .category-selector-inline .category-tab{
            flex: 1 1 calc(50% - 8px);
        }
        #climate-inline-container{
            margin-left: calc(-1 * (50vw - 50%));
            margin-right: calc(-1 * (50vw - 50%));
            width: 100vw;
            max-width: none;
            padding: 0;
            border-radius: 0;
            border: none;
        }
        #climate-inline-container img{
            width: 100%;
            max-width: none;
            border-radius: 0;
            box-shadow: none;
        }
    }

    /* Selector en modo inline (m√≥vil) */
    .category-selector-inline{
        position: static;
        width: 100%;
        border-radius: 14px;
        border: 1px solid rgba(255,255,255,0.08);
        padding: 12px;
        background: rgba(6, 20, 58, 0.95);
        box-shadow: 0 8px 22px rgba(0,0,0,0.35);
        display: flex !important;
        justify-content: center;
    }
    .category-selector-inline .category-tabs{
        display: grid;
        width: 100%;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 10px;
        background: transparent;
        padding: 0;
    }
    .category-selector-inline .category-tab{
        flex: unset;
        width: 100%;
        border: 1px solid rgba(255,255,255,0.14);
        border-radius: 10px;
        background: rgba(14, 32, 88, 0.85);
        box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
    }
    .category-mobile-slot{
        width: 100%;
        margin: 12px 0;
    }
    .category-selector-hidden{
        visibility: hidden !important;
        pointer-events: none !important;
    }

    @media (max-width: 480px) {
        .category-tabs {
            gap: 4px;
            padding: 2px;
        }
        
        .category-tab {
            padding: 6px 12px;
            font-size: 12px;
        }
    }

    /* Utility class */
    .hidden {
        opacity: 0 !important;
        visibility: hidden !important;
    }

    /* Hero final fuera de Scrollama */
    #hero-final{
      position:relative; z-index:9;
      min-height:100vh; width:100%;
      display:flex; flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      padding-top:18vh;
      background-image: url('./assets/Esperanza.webp');
      background-size:cover; 
      background-position:center;
      box-shadow: inset 0 -200px 200px rgba(0,0,0,.35);
    }

    /* Slider vertical para comparaci√≥n de im√°genes Cimadevila */
    .vertical-slider-container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
    }

    .vertical-slider-wrapper {
        position: relative;
        width: 100%;
        max-width: 100%;
        aspect-ratio: 4 / 3; /* Ajustar seg√∫n tus im√°genes */
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 8px 26px rgba(0, 0, 0, 0.35);
        cursor: ns-resize;
    }

    .vertical-slider-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .vertical-slider-img-bottom {
        z-index: 1;
    }

    .vertical-slider-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 2;
        clip-path: inset(0 0 50% 0);
        will-change: clip-path;
        transform: translateZ(0); /* Aceleraci√≥n GPU */
    }

    .vertical-slider-overlay.dragging {
        transition: none; /* Sin transici√≥n durante el drag */
    }

    .vertical-slider-img-top {
        z-index: 3;
    }

    .vertical-slider-handle {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 4px;
        margin: 0;
        z-index: 10;
        cursor: ns-resize;
        transform: translateY(-50%) translateZ(0); /* Aceleraci√≥n GPU */
        pointer-events: none;
        will-change: top;
    }

    .vertical-slider-handle-icon {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        border: 3px solid #F44E11;
        cursor: grab;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        transition: all 0.2s ease;
        pointer-events: all;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vertical-slider-handle-icon::before {
        content: '‚ò∞';
        font-size: 16px;
        color: #F44E11;
        line-height: 1;
    }

    .vertical-slider-handle-icon:hover {
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
    }

    .vertical-slider-handle-icon:active {
        cursor: grabbing;
        transform: translate(-50%, -50%) scale(0.95);
    }

    .vertical-slider-labels {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 5;
        pointer-events: none;
        width: 100%;
        height: 100%;
        justify-content: space-between;
        padding: 16px 0;
    }

    .vertical-slider-label-top,
    .vertical-slider-label-bottom {
        background: none;
        color: white;
        padding: 0;
        border-radius: 0;
        font-size: 48px;
        font-weight: 700;
        white-space: nowrap;
        backdrop-filter: none;
        text-align: center;
        align-self: center;
        text-shadow: 0 1px 3px rgba(255, 255, 255, 0.6),
                     0 2px 6px rgba(255, 255, 255, 0.4);
    }

    .vertical-slider-label-top {
        order: 1;
    }

    .vertical-slider-label-bottom {
        order: 2;
    }

    /* L√≠nea indicadora en el slider */
    .vertical-slider-handle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 2px;
        background: rgba(244, 78, 17, 0.6);
        z-index: -1;
        transform: translateY(-50%);
        pointer-events: none;
    }

    @media (max-width: 768px) {
        .vertical-slider-handle-icon {
            width: 32px;
            height: 32px;
        }

        .vertical-slider-handle-icon::before {
            font-size: 14px;
        }

        .vertical-slider-labels {
            padding: 12px 0;
        }

        .vertical-slider-label-top,
        .vertical-slider-label-bottom {
            font-size: 36px;
        }
    }

    @media (max-width: 480px) {
        .vertical-slider-label-top,
        .vertical-slider-label-bottom {
            font-size: 28px;
        }
    }
  </style>
</head>
<script>
window.addEventListener('load', () => {
  // üîπ Tama√±o del incendio de Larouco‚ÄìSeadur (2025): 31.700 ha ‚âà 317 km¬≤
  const FIRE_KM2 = 317;

  // Utilidades
  const fmt = n => (Math.round(n * 100) / 100).toLocaleString('es-ES');

  // ‚Äî‚Äî‚Äî UI refs (el comparador est√° en el description del cap√≠tulo o en el HTML) ‚Äî‚Äî‚Äî
  function els() {
    return {
      select: document.getElementById('city'),
      out: document.getElementById('result'),
      fireCircle: document.getElementById('fire-circle'),
      cityCircle: document.getElementById('city-circle'),
      circleLabel: document.getElementById('circle-label'),
      mosaicContainer: document.getElementById('mosaic-compare'),
      circleContainer: document.getElementById('circle-compare'),
      mosaicWrap: document.querySelector('#mosaic-compare .mosaic-wrap'),
      mosaicGrid: document.getElementById('mosaic-grid'),
      mosaicRing: document.getElementById('mosaic-ring'),
      mosaicLabel: document.getElementById('mosaic-label'),
    };
  }

  // ‚Äî‚Äî‚Äî Par√°metros del mosaico ‚Äî‚Äî‚Äî
  const MOSAIC_N = 12;           // tama√±o de la cuadr√≠cula NxN (menos celdas ‚Üí iconos m√°s grandes)
  const MOSAIC_GAP = 1;          // px de separaci√≥n entre iconos (ligeramente menor)
  const CITY_COLOR = '#2E7DF5';  // azul para la ciudad
  const FIRE_ICON = './assets/icons_city/fire-1-svgrepo-com.svg';
  const BUILDING_ICONS = [
    './assets/icons_city/building-svgrepo-com.svg',
    './assets/icons_city/apartment-svgrepo-com.svg',
    './assets/icons_city/city-buildings-svgrepo-com.svg',
    './assets/icons_city/company-svgrepo-com.svg',
    './assets/icons_city/embassy-svgrepo-com.svg',
    './assets/icons_city/residential-svgrepo-com.svg',
    './assets/icons_city/skyscrapers-svgrepo-com.svg',
    './assets/icons_city/city-svgrepo-com.svg',
    './assets/icons_city/house-svgrepo-com.svg',
    './assets/icons_city/parliament-svgrepo-com.svg'
  ];

  function randomChoice(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
  function clamp(v, a, b) { return Math.max(a, Math.min(b, v)); }

  // Aplica un icono SVG como m√°scara al tile
  function setTileMask(div, url) {
    div.style.webkitMaskImage = `url('${url}')`;
    div.style.maskImage = `url('${url}')`;
    div.style.webkitMaskRepeat = 'no-repeat';
    div.style.maskRepeat = 'no-repeat';
    div.style.webkitMaskPosition = 'center';
    div.style.maskPosition = 'center';
    div.style.webkitMaskSize = 'contain';
    div.style.maskSize = 'contain';
  }

  // Construye el mosaico si a√∫n no existe
  function buildMosaic(n = MOSAIC_N) {
    const { mosaicGrid, mosaicWrap } = els();
    if (!mosaicGrid || !mosaicWrap) return;
    if (mosaicGrid.childElementCount > 0) return; // ya creado

    mosaicGrid.style.setProperty('--n', n.toString());
    mosaicGrid.style.setProperty('--gap', `${MOSAIC_GAP}px`);

    const frag = document.createDocumentFragment();
    for (let y = 0; y < n; y++) {
      for (let x = 0; x < n; x++) {
        const tile = document.createElement('div');
        tile.className = 'tile';
        tile.dataset.x = String(x);
        tile.dataset.y = String(y);
        tile.style.backgroundColor = CITY_COLOR;
        setTileMask(tile, randomChoice(BUILDING_ICONS));
        frag.appendChild(tile);
      }
    }
    mosaicGrid.appendChild(frag);
  }

  // Crea/actualiza el anillo de llamas que rodea la ciudad cuando el fuego > 100%
  function renderRing(times) {
    const { mosaicRing, mosaicWrap } = els();
    if (!mosaicRing || !mosaicWrap) return;
    mosaicRing.innerHTML = '';

    if (!(times > 1)) return; // sin anillo si no excede

    const k = clamp(Math.round(8 + 8 * Math.log2(times)), 12, 24);
    const rect = mosaicWrap.getBoundingClientRect();
    const r = Math.min(rect.width, rect.height) * 0.55; // radio hacia fuera

    for (let i = 0; i < k; i++) {
      const flame = document.createElement('div');
      flame.className = 'flame';
      const angle = (i / k) * 360;
      flame.style.transform = `rotate(${angle}deg) translate(${r}px) rotate(${-angle}deg)`;
      mosaicRing.appendChild(flame);
    }
  }

  // Anillos conc√©ntricos ‚Äúrodeando la ciudad‚Äù:
  // 1) Columna derecha (arriba‚Üíabajo), 2) fila inferior (derecha‚Üíizquierda),
  // 3) columna izquierda (abajo‚Üíarriba), 4) fila superior (izquierda‚Üíderecha),
  // y as√≠ hacia dentro. Devuelve array de anillos (cada anillo es array de [x,y]).
  function ringOrders(n){
    const rings = [];
    let top = 0, bottom = n - 1, left = 0, right = n - 1;
    while (left <= right && top <= bottom) {
      const ring = [];
      for (let y = top; y <= bottom; y++) ring.push([right, y]);          // derecha
      for (let x = right - 1; x >= left; x--) ring.push([x, bottom]);     // abajo
      for (let y = bottom - 1; y >= top; y--) ring.push([left, y]);       // izquierda
      for (let x = left + 1; x <= right - 1; x++) ring.push([x, top]);    // arriba
      rings.push(ring);
      left++; right--; top++; bottom--;
    }
    return rings;
  }

  // Actualiza el mosaico con patr√≥n de quemado de izquierda a derecha
  function updateMosaic(city) {
    const { mosaicLabel, mosaicContainer, circleContainer, mosaicRing } = els();
    buildMosaic();

    const n = MOSAIC_N;
    const tiles = Array.from(document.querySelectorAll('#mosaic-grid .tile'));
    // Reset: ciudad azul con edificios, sin fuego ni quemado
    tiles.forEach(t => {
      t.classList.remove('burned', 'flame');
      t.style.backgroundColor = CITY_COLOR;
      setTileMask(t, randomChoice(BUILDING_ICONS));
      t.style.transform = ''; // asegurar que no haya rotaci√≥n previa
    });

    const ratio = FIRE_KM2 / city.km2;
    const total = n * n;
    const burnCount = Math.min(total, Math.round(total * Math.min(1, ratio)));

    // Llenado por columnas (izq‚Üídcha) con borde ligeramente irregular
    const fullCols = Math.floor(burnCount / n);
    const remainder = burnCount % n;

    // Quemar columnas completas
    tiles.forEach(tile => {
      const x = parseInt(tile.dataset.x, 10);
      const y = parseInt(tile.dataset.y, 10);
      if (x < fullCols) {
        tile.classList.add('burned');
      } else if (x === fullCols && remainder > 0) {
        // Jitter vertical de ¬±1 fila en la frontera
        const jitter = Math.round((Math.random() * 2) - 1); // -1,0,1
        const threshold = clamp(remainder + jitter, 0, n);
        if (y < threshold) tile.classList.add('burned');
      }
    });

    // Limpiar anillo externo (ya no se usa este modo)
    if (mosaicRing) mosaicRing.innerHTML = '';

    // Si el incendio es mayor, a√±adir iconos de fuego rodeando la ciudad (por anillos)
    if (ratio > 1) {
      // Toda la ciudad est√° quemada
      tiles.forEach(t => t.classList.add('burned'));

      // Cantidad de celdas ‚Äúextra‚Äù que representan el exceso sobre la ciudad
      let remaining = Math.max(0, Math.round(total * (ratio - 1)));
      if (remaining > 0) {
        const rings = ringOrders(n);
        const MAX_RINGS = 2; // limitar para que no se convierta ‚Äútodo en fuego‚Äù en casos extremos
        for (let r = 0; r < rings.length && remaining > 0 && r < MAX_RINGS; r++) {
          const ring = rings[r];
          for (let i = 0; i < ring.length && remaining > 0; i++) {
            const [x, y] = ring[i];
            const tile = tiles.find(t => parseInt(t.dataset.x,10) === x && parseInt(t.dataset.y,10) === y);
            if (!tile) continue;
            tile.classList.add('flame');
            setTileMask(tile, FIRE_ICON);
            remaining--;
          }
        }
      }
    }

    if (mosaicLabel) {
      mosaicLabel.innerHTML = `<span style="color: #F44E11">Incendio (${fmt(FIRE_KM2)} km¬≤)</span> vs <span style="color: ${CITY_COLOR}">${city.name} (${fmt(city.km2)} km¬≤)</span>${ratio>1 ? ` ‚Äî <span style="opacity:.9">√ó${fmt(ratio)}</span>` : ''}`;
    }

    // Mostrar mosaico, ocultar c√≠rculos (fallback sigue disponible)
    if (mosaicContainer) mosaicContainer.style.display = 'block';
    if (circleContainer) circleContainer.style.display = 'none';
  }

  // ‚Äî‚Äî‚Äî Dibuja/actualiza c√≠rculos conc√©ntricos ‚Äî‚Äî‚Äî
  function updateCircles(cityName, cityKm2) {
    const largeCircle = document.getElementById('large-circle');
    const smallCircle = document.getElementById('small-circle');
    const circleLabel = document.getElementById('circle-label');
    if (!largeCircle || !smallCircle || !circleLabel) return;

    const svgSize = 300;
    const maxR = (svgSize / 2) - 10;
    const SCALE = 6;

    const fireR = Math.sqrt(FIRE_KM2) * SCALE;
    const cityR = Math.sqrt(cityKm2) * SCALE;
    const factor = Math.min(1, maxR / Math.max(fireR, cityR));

    // Determinar cu√°l es m√°s grande
    if (FIRE_KM2 >= cityKm2) {
      // El fuego es m√°s grande -> va atr√°s
      largeCircle.setAttribute('fill', '#F44E11');
      largeCircle.setAttribute('stroke', '#F44E11');
      smallCircle.setAttribute('fill', 'rgb(0,120,255)');
      smallCircle.setAttribute('stroke', 'rgba(0,120,255,0.5)');
      largeCircle.setAttribute('r', fireR * factor);
      smallCircle.setAttribute('r', cityR * factor);
    } else {
      // La ciudad es m√°s grande -> va atr√°s
      largeCircle.setAttribute('fill', 'rgb(0,120,255)');
      largeCircle.setAttribute('stroke', 'rgb(0,120,255)');
      smallCircle.setAttribute('fill', '#F44E11');
      smallCircle.setAttribute('stroke', '#F44E11');
      largeCircle.setAttribute('r', cityR * factor);
      smallCircle.setAttribute('r', fireR * factor);
    }
    circleLabel.innerHTML = `<span style="color: #F44E11">Incendio (${fmt(FIRE_KM2)} km¬≤)</span> vs <span style="color: rgb(0,120,255)">${cityName} (${fmt(cityKm2)} km¬≤)</span>`;
  }

  // ‚Äî‚Äî‚Äî Texto comparativo ‚Äî‚Äî‚Äî
  function updateText(city) {
    const { out } = els();
    if (!out) return;

    if (FIRE_KM2 >= city.km2) {
      const times = FIRE_KM2 / city.km2;
      out.textContent = `El √°rea quemada equivale a ${fmt(times)} veces el √°rea municipal de ${city.name} (${fmt(FIRE_KM2)} km¬≤ vs ${fmt(city.km2)} km¬≤).`;
    } else {
      const percent = (FIRE_KM2 / city.km2) * 100;
      out.textContent = `El √°rea quemada equivale al ${fmt(percent)}% del √°rea municipal de ${city.name} (${fmt(FIRE_KM2)} km¬≤ vs ${fmt(city.km2)} km¬≤).`;
    }
  }

  // ‚Äî‚Äî‚Äî Cargar CSV y montar la UI ‚Äî‚Äî‚Äî
  // Si no existe el selector de ciudad, no cargar el CSV ni montar nada
  const __selectExists = !!els().select;
  if (!__selectExists) {
    return;
  }
  fetch('./assets/cities.csv?v=6')   // sube el n√∫mero si actualizas el CSV para evitar cach√©
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} al cargar assets/cities.csv`);
      return r.text();
    })
    .then(txt => {
      // Parse CSV muy tolerante (ignora l√≠neas vac√≠as)
      const rows = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (!rows.length) throw new Error('CSV vac√≠o');

      const headers = rows.shift().split(',').map(h => h.trim());
      const nameIdx = headers.indexOf('name');
      const kmIdx   = headers.indexOf('km2');
      if (nameIdx < 0 || kmIdx < 0) throw new Error('CSV debe tener columnas "name" y "km2"');

      const cities = rows.map(line => {
        const cols = line.split(',');
        return { name: (cols[nameIdx] || '').trim(), km2: parseFloat((cols[kmIdx] || '').trim()) };
      }).filter(c => c.name && Number.isFinite(c.km2));

      const { select } = els();
      if (!select) {
        console.warn('No se encontr√≥ <select id="city">. ¬øInsertaste el comparador en el description del cap√≠tulo o en el HTML?');
        return;
      }

      // Rellenar <select> plano (sin grupos)
      cities.forEach(c => {
        const o = document.createElement('option');
        o.value = c.name;
        o.textContent = c.name;
        select.appendChild(o);
      });

      // Ocultar el contenedor de c√≠rculos inicialmente
      document.getElementById('circle-compare').style.display = 'none';
      // Ocultar tambi√©n el mosaico inicialmente
      const mc = document.getElementById('mosaic-compare');
      if (mc) mc.style.display = 'none';

      // Evento cambio
      select.addEventListener('change', () => {
        const city = cities.find(x => x.name === select.value);
        const { out } = els();
        const circleContainer = document.getElementById('circle-compare');
        const mosaicContainer = document.getElementById('mosaic-compare');
        
        if (!city) {
          // Si no hay ciudad seleccionada, limpiar la visualizaci√≥n
          if (out) out.textContent = '';
          if (circleContainer) circleContainer.style.display = 'none';
          if (mosaicContainer) mosaicContainer.style.display = 'none';
          return;
        }
        
        // Mostrar el contenedor del mosaico (y ocultar c√≠rculos)
        if (mosaicContainer) mosaicContainer.style.display = 'block';
        if (circleContainer) circleContainer.style.display = 'none';
        updateText(city);
        updateMosaic(city);
      });

      // A√±adir opci√≥n vac√≠a al inicio
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'Selecciona una ciudad';
      select.insertBefore(emptyOption, select.firstChild);
      select.value = '';
    })
    .catch(err => {
      console.error(err);
      const { out } = els();
      if (out) out.textContent = 'No se pudo cargar la lista de ciudades.';
    });
});
</script>
<style>
  /* Estilo de la etiqueta (solo texto) */
  .map-label{
    color:rgba(255,255,255,0.85); font-weight:700; font-size:14px; 
    text-shadow:0 0 6px rgba(0,0,0,.7);
    background:rgba(0,0,0,.35); padding:2px 6px; border-radius:4px;
    white-space:nowrap; user-select:none;
  }

  /* ====== Mosaico comparador (ciudad vs incendio) ====== */
  #mosaic-compare .mosaic-wrap{
    position: relative;
    display: inline-block;
    width: 320px;
    max-width: 100%;
    aspect-ratio: 1 / 1;
  }
  #mosaic-compare .mosaic-grid{
    width: 100%;
    height: 100%;
    display: grid;
    grid-template-columns: repeat(var(--n, 14), 1fr);
    grid-template-rows: repeat(var(--n, 14), 1fr);
    gap: var(--gap, 2px);
  }
  #mosaic-compare .tile{
    background-color: #2E7DF5; /* color ciudad */
    transition: background-color .25s ease, filter .25s ease, transform .2s ease;
    -webkit-mask-repeat: no-repeat;
    -webkit-mask-position: center;
    -webkit-mask-size: contain;
    mask-repeat: no-repeat;
    mask-position: center;
    mask-size: contain;
  }
  #mosaic-compare .tile.burned{
    background: linear-gradient(to top, #000 0%, #FF3B00 50%, #FF6A00 100%);
    filter: drop-shadow(0 0 4px rgba(255,59,0,0.35));
  }
  #mosaic-compare .tile.flame{
    background: linear-gradient(to top, #000 0%, #FF3B00 50%, #FF6A00 100%);
    filter: drop-shadow(0 0 5px rgba(255,59,0,0.55));
  }
  #mosaic-compare .mosaic-ring{
    position: absolute;
    inset: -8%;
    pointer-events: none;
  }
  #mosaic-compare .mosaic-ring .flame{
    position: absolute;
    width: 14px;
    height: 14px;
    left: 50%;
    top: 50%;
    transform-origin: center;
    background: linear-gradient(145deg, #FF6A00, #FF3B00);
    -webkit-mask-image: url('./assets/icons_city/fire-1-svgrepo-com.svg');
    -webkit-mask-repeat: no-repeat;
    -webkit-mask-size: contain;
    -webkit-mask-position: center;
    mask-image: url('./assets/icons_city/fire-1-svgrepo-com.svg');
    mask-repeat: no-repeat;
    mask-size: contain;
    mask-position: center;
    filter: drop-shadow(0 0 4px rgba(255,59,0,0.45));
    opacity: .95;
  }
</style>

<script>
  // 1) Crear la etiqueta como marcador HTML, pero NO a√±adirla a√∫n
  let laroucoMarker = null;
  function createLaroucoLabel() {
    const el = document.createElement('div');
    el.className = 'map-label';
    el.innerHTML = '<span style="opacity: 0.65">Larouco‚ÄìSeadur<br><span style="font-size: 0.9em">(2025)</span></span>';
    el.style.textAlign = 'center';
    laroucoMarker = new mapboxgl.Marker({ element: el, anchor: 'center' });
  }

  // 2) Funciones globales para mostrar/ocultar (las llamaremos desde el cap√≠tulo)
  window.showLarouco = function(delayMs = 0){
    if (!window.map || !map.isStyleLoaded()) return;
    
    // Primero asegurar que est√© oculto antes de mostrarlo
    window.hideLarouco();
    
    if (!laroucoMarker) createLaroucoLabel();
    const coords = [-7.08, 42.65];        // [lng, lat] aprox. Larouco‚ÄìSeadur
    
    const doAdd = () => {
      try {
        if (laroucoMarker && map.isStyleLoaded()) {
          laroucoMarker.setLngLat(coords).addTo(map);
        }
      } catch(error) {
        console.warn('Error mostrando marcador Larouco:', error);
      }
    };
    
    delayMs ? setTimeout(doAdd, delayMs) : doAdd();
  };
  
  window.hideLarouco = function(){
    if (laroucoMarker) { 
      try { 
        laroucoMarker.remove(); 
      } catch(e) {
        console.warn('Error ocultando marcador Larouco:', e);
      }
    }
  };

  // Ajustar padding inferior del contenedor de cap√≠tulos al entrar/salir del hero final
  window.tightenFinalHero = function(){
    try{
      const features = document.getElementById('features');
      if (features) features.style.paddingBottom = '0';
    } catch(e) {}
  };
  window.resetStoryPadding = function(){
    try{
      const features = document.getElementById('features');
      if (features) features.style.paddingBottom = '10vh';
    } catch(e) {}
  };

  // Ocultar/mostrar atribuciones y controles del mapa para el hero final
  let prevBottomLeftDisplay = null;
  let prevBottomRightDisplay = null;
  window.hideMapAttribution = function(){
    try{
      const bl = document.querySelector('.mapboxgl-ctrl-bottom-left');
      const br = document.querySelector('.mapboxgl-ctrl-bottom-right');
      if (bl){ prevBottomLeftDisplay = bl.style.display; bl.style.display = 'none'; }
      if (br){ prevBottomRightDisplay = br.style.display; br.style.display = 'none'; }
    } catch(e) {}
  };
  window.showMapAttribution = function(){
    try{
      const bl = document.querySelector('.mapboxgl-ctrl-bottom-left');
      const br = document.querySelector('.mapboxgl-ctrl-bottom-right');
      if (bl){ bl.style.display = prevBottomLeftDisplay || ''; }
      if (br){ br.style.display = prevBottomRightDisplay || ''; }
    } catch(e) {}
  };

  // Funciones para controlar capas ocultas por defecto
  window.hideDefaultLayers = function() {
    if (config.hiddenLayers && window.map) {
      config.hiddenLayers.forEach(layerId => {
        try {
          if (map.getLayer(layerId)) {
            map.setLayoutProperty(layerId, 'visibility', 'none');
          }
        } catch (error) {
          console.warn(`Error ocultando capa por defecto ${layerId}:`, error);
        }
      });
    }
    
    // Tambi√©n asegurar que las capas de fuego est√©n ocultas cuando se llama esta funci√≥n
    const fireLayerIds = ['FIRES_GLOW_POINT_1', 'FIRES_GLOW_POINT_2', 'FIRES_GLOW_POINT_3', 'FIRES_PERIMETER'];
    fireLayerIds.forEach(layerId => {
      try {
        if (map.getLayer(layerId)) {
          const props = getLayerPaintType(layerId);
          props.forEach(prop => {
            map.setPaintProperty(layerId, prop, 0, { duration: 0 });
          });
        }
      } catch (error) {
        console.warn(`Error ocultando capa de fuego ${layerId}:`, error);
      }
    });
    
    // Ocultar tambi√©n el marcador de Larouco
    window.hideLarouco();

    if (typeof window.__afterHideDefaultLayers === 'function') {
      try { window.__afterHideDefaultLayers(); } catch(e) {}
    }
  };

  // Funciones para mostrar capas espec√≠ficas cuando las necesites
  window.showRelieve = function() {
    if (window.map && map.getLayer('RELIEVE')) {
      map.setLayoutProperty('RELIEVE', 'visibility', 'visible');
    }
  };

  window.showUsourense = function() {
    if (window.map && map.getLayer('USOURENSE')) {
      map.setLayoutProperty('USOURENSE', 'visibility', 'visible');
    }
  };

  window.showXeourense = function() {
    if (window.map && map.getLayer('XEOURENSE')) {
      map.setLayoutProperty('XEOURENSE', 'visibility', 'visible');
    }
  };

  // 3) Sistema robusto para manejar transiciones entre cap√≠tulos
  let currentChapterId = null;
  let activeTimers = new Set();
  
  // Funci√≥n para limpiar todos los timers activos
  function clearAllTimers() {
    activeTimers.forEach(timerId => clearTimeout(timerId));
    activeTimers.clear();
  }
  
  // Funci√≥n para limpiar completamente el estado del cap√≠tulo anterior
  function forceCleanupChapter(chapterId) {
    const chapter = config.chapters.find(ch => ch.id === chapterId);
    if (!chapter) return;
    
    // Ejecutar inmediatamente todos los onChapterExit sin delays
    (chapter.onChapterExit || []).forEach(entry => {
      if (entry.layer) {
        // Forzar la opacidad a 0 inmediatamente
        const props = getLayerPaintType(entry.layer);
        props.forEach(prop => {
          map.setPaintProperty(entry.layer, prop, 0, { duration: 0 });
        });
      }
      if (typeof entry.callback === 'function') entry.callback();
      if (typeof entry.callbackName === 'string' && typeof window[entry.callbackName] === 'function') {
        window[entry.callbackName]();
      }
    });
    
    // Limpiar espec√≠ficamente las capas de fuego y Larouco
    if (chapterId === 'incendios-2025') {
      const fireLayerIds = ['FIRES_GLOW_POINT_1', 'FIRES_GLOW_POINT_2', 'FIRES_GLOW_POINT_3', 'FIRES_PERIMETER'];
      fireLayerIds.forEach(layerId => {
        if (map.getLayer(layerId)) {
          const props = getLayerPaintType(layerId);
          props.forEach(prop => {
            map.setPaintProperty(layerId, prop, 0, { duration: 0 });
          });
        }
      });
      window.hideLarouco();
    }
  }

  window.enableChapterCallbacks = function(scroller, config, setLayerOpacity){
    const isMobile = window.matchMedia('(max-width: 768px)').matches;
    const offsetVal = 0.6; // mismo offset en m√≥vil y escritorio para transiciones coherentes
    scroller
      .setup({ step: '.step', offset: offsetVal, progress: true })
      .onStepEnter(function(response){
        const newChapterId = response.element.id;
        const chapter = config.chapters.find(ch => ch.id === newChapterId);
        
        // Limpiar timers anteriores
        clearAllTimers();
        
        // Si cambiamos de cap√≠tulo, forzar limpieza del anterior
        if (currentChapterId && currentChapterId !== newChapterId) {
          forceCleanupChapter(currentChapterId);
        }
        
        currentChapterId = newChapterId;
        response.element.classList.add('active');
        map[chapter.mapAnimation || 'flyTo'](chapter.location);

        (chapter.onChapterEnter || []).forEach(entry => {
          if (entry.layer) setLayerOpacity(entry);
          if (typeof entry.callback === 'function') entry.callback();
          if (typeof entry.callbackName === 'string' && typeof window[entry.callbackName] === 'function') {
            if (entry.delay && entry.delay > 0) {
              const timerId = setTimeout(() => {
                window[entry.callbackName](entry.delay || 0);
                activeTimers.delete(timerId);
              }, entry.delay);
              activeTimers.add(timerId);
            } else {
              window[entry.callbackName](entry.delay || 0);
            }
          }
        });
      })
      .onStepExit(function(response){
        const exitingChapterId = response.element.id;
        const chapter = config.chapters.find(ch => ch.id === exitingChapterId);
        response.element.classList.remove('active');

        // Ejecutar callbacks de salida con manejo robusto
        (chapter.onChapterExit || []).forEach(entry => {
          if (entry.layer) setLayerOpacity(entry);
          if (typeof entry.callback === 'function') entry.callback();
          if (typeof entry.callbackName === 'string' && typeof window[entry.callbackName] === 'function') {
            if (entry.delay && entry.delay > 0) {
              const timerId = setTimeout(() => {
                window[entry.callbackName](entry.delay || 0);
                activeTimers.delete(timerId);
              }, entry.delay);
              activeTimers.add(timerId);
            } else {
              window[entry.callbackName](entry.delay || 0);
            }
          }
        });
      });
  };

  // Funci√≥n para inicializar el slider vertical de Cimadevila
  window.initCimadevilaSlider = function() {
    const sliderHandle = document.getElementById('cimadevila-slider');
    const overlay = document.querySelector('.vertical-slider-overlay');
    const wrapper = document.querySelector('.vertical-slider-wrapper');
    
    if (!sliderHandle || !overlay || !wrapper) {
      // Si el cap√≠tulo a√∫n no est√° en el DOM, esperar un poco
      setTimeout(() => window.initCimadevilaSlider(), 100);
      return;
    }

    let isDragging = false;
    let currentPercent = 50; // Inicializar en el medio
    let rafId = null;
    let cachedRect = null;
    let needsRectUpdate = true;

    // Funci√≥n optimizada para actualizar el slider usando requestAnimationFrame
    function updateSlider(percent, immediate = false) {
      // Limitar entre 0 y 100
      const newPercent = Math.max(0, Math.min(100, percent));
      
      // Solo actualizar si el valor cambi√≥
      if (Math.abs(newPercent - currentPercent) < 0.01 && !immediate) return;
      
      currentPercent = newPercent;
      
      // Funci√≥n de renderizado optimizada
      function render() {
        const clipValue = `${currentPercent}%`;
        // clip-path: 
        // - percent=0 (arriba): inset(0% 0 0 0) ‚Üí muestra todo el overlay (1957) ‚úì
        // - percent=100 (abajo): inset(100% 0 0 0) ‚Üí oculta overlay, muestra fondo (2021) ‚úì
        // Cuando arrastras hacia abajo (percent aumenta), el clip-path aumenta, ocultando m√°s overlay y mostrando m√°s fondo (2021) ‚úì
        overlay.style.clipPath = `inset(${currentPercent}% 0 0 0)`;
        sliderHandle.style.top = clipValue;
        
        if (wrapper) {
          wrapper.style.setProperty('--slider-line-top', clipValue);
        }
      }
      
      // Usar requestAnimationFrame para suavizar las actualizaciones
      if (immediate) {
        render();
      } else {
        if (rafId !== null) {
          cancelAnimationFrame(rafId);
        }
        rafId = requestAnimationFrame(render);
      }
    }

    // Inicializar en el medio (50%)
    updateSlider(50, true);

    // Cach√© de las dimensiones del wrapper para evitar getBoundingClientRect() repetido
    function getWrapperRect() {
      if (needsRectUpdate || !cachedRect) {
        cachedRect = wrapper.getBoundingClientRect();
        needsRectUpdate = false;
      }
      return cachedRect;
    }

    function getPercentFromEvent(e) {
      const rect = getWrapperRect();
      let clientY;
      if (e.touches && e.touches.length > 0) {
        clientY = e.touches[0].clientY;
      } else {
        clientY = e.clientY;
      }
      const percent = ((clientY - rect.top) / rect.height) * 100;
      return Math.max(0, Math.min(100, percent));
    }

    // Event listeners para el handle y el wrapper completo
    const handleIcon = sliderHandle.querySelector('.vertical-slider-handle-icon');
    
    function startDrag(e) {
      isDragging = true;
      needsRectUpdate = true; // Forzar actualizaci√≥n del rect al iniciar
      e.preventDefault();
      e.stopPropagation();
      
      // Prevenir selecci√≥n de texto mientras se arrastra
      document.body.style.userSelect = 'none';
      document.body.style.cursor = 'ns-resize';
      
      // Desactivar transiciones durante el drag
      overlay.classList.add('dragging');
      
      // Actualizar inmediatamente al inicio
      const percent = getPercentFromEvent(e);
      updateSlider(percent, true);
    }

    function drag(e) {
      if (!isDragging) return;
      e.preventDefault();
      
      const percent = getPercentFromEvent(e);
      updateSlider(percent);
    }

    function endDrag(e) {
      isDragging = false;
      needsRectUpdate = true;
      e.preventDefault();
      e.stopPropagation();
      
      // Restaurar selecci√≥n de texto
      document.body.style.userSelect = '';
      document.body.style.cursor = '';
      
      // Asegurar renderizado final
      if (rafId !== null) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
      updateSlider(currentPercent, true);
      
      // Reactivar transiciones despu√©s del drag
      overlay.classList.remove('dragging');
    }

    // Actualizar rect cuando la ventana cambia de tama√±o o se hace scroll
    function invalidateRect() {
      needsRectUpdate = true;
    }
    
    window.addEventListener('resize', invalidateRect);
    window.addEventListener('scroll', invalidateRect, true);

    // Eventos del mouse
    handleIcon.addEventListener('mousedown', startDrag);
    wrapper.addEventListener('mousedown', function(e) {
      if (e.target !== handleIcon && !handleIcon.contains(e.target)) {
        startDrag(e);
        // startDrag ya actualiza el slider inmediatamente, no hace falta aqu√≠
      }
    });
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', endDrag);

    // Eventos t√°ctiles (touch)
    handleIcon.addEventListener('touchstart', startDrag, { passive: false });
    wrapper.addEventListener('touchstart', function(e) {
      if (e.target !== handleIcon && !handleIcon.contains(e.target)) {
        startDrag(e);
        // startDrag ya actualiza el slider inmediatamente, no hace falta aqu√≠
      }
    }, { passive: false });
    
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('touchend', endDrag);
    document.addEventListener('touchcancel', endDrag);
  };
</script>


<body>

  <!-- MAPA DETR√ÅS -->
  <div id="map"></div>
  <div class="map-source fixed">Fuente: forest-fire.emergency.copernicus.eu/</div>

<!-- HEADER -->
<header id="topbar" role="banner" aria-label="Cabecera">
  <div id="brand">Miguel Ferreiro Garc√≠a</div>
  <div id="titleRight">¬øPor qu√© arden nuestros montes?</div>
</header>

<!-- SELECTOR DE CATEGOR√çAS -->
<div id="category-selector-home" class="category-selector-home">
  <div id="category-selector" class="category-selector">
      <div class="category-tabs" role="tablist" aria-label="Seleccionar categor√≠a de informaci√≥n">
          <button class="category-tab" role="tab" data-category="geologia" aria-pressed="false" tabindex="0">
              Geolog√≠a
          </button>
          <button class="category-tab" role="tab" data-category="vegetacion" aria-pressed="false" tabindex="-1">
              Vegetaci√≥n
          </button>
          <button class="category-tab" role="tab" data-category="clima" aria-pressed="false" tabindex="-1">
              Clima
          </button>
          <button class="category-tab" role="tab" data-category="geografia" aria-pressed="false" tabindex="-1">
              Geograf√≠a
          </button>
      </div>
  </div>
</div>

<!-- Overlay para im√°genes de clima -->
<div id="climate-images-overlay" class="climate-images-overlay hidden">
    <div class="climate-images-container">
        <img id="larouco-clima-img" src="assets/Larouco_Clima.png" alt="Clima en Larouco" class="climate-img-large" />
        <img id="fases-clima-img" src="assets/Fases_Clima.png" alt="Fases del clima" class="climate-img-small" />
    </div>
</div>

  <!-- HERO DE APERTURA -->
  <section id="hero" aria-label="Portada">
    <div class="hero-inner">
      <h1 class="hero-headline">
        ¬øPor qu√© arden nuestros montes?
      </h1>
      <div class="hero-kicker">
        <p>Un verano extremo, mucha vegetaci√≥n acumulada y un paisaje que ya no se comporta como antes.<span class="mobile-break"></span> Con ayuda de los datos intentaremos entender por qu√© los incendios siguen golpeando con tanta fuerza al noroeste peninsular.</p>
      </div>
    </div>
    <div class="scroll-hint">Desliza para explorar</div>
    <div class="photo-credit">FOTO: Pedro Armestre</div>
</section>


  <!-- STORYMAP -->
  <div id="story"></div>

  <script src="./config.js"></script>
  <script>
    // ==== Construcci√≥n DOM del storytelling (plantilla Mapbox) ====
    var layerTypes = {
      'fill': ['fill-opacity'],
      'line': ['line-opacity'],
      'circle': ['circle-opacity','circle-stroke-opacity'],
      'symbol': ['icon-opacity','text-opacity'],
      'raster': ['raster-opacity'],
      'fill-extrusion': ['fill-extrusion-opacity'],
      'heatmap': ['heatmap-opacity']
    };
    var alignments = { left:'lefty', center:'centered', right:'righty', full:'fully' };
    var story = document.getElementById('story');
    var features = document.createElement('div'); features.id='features';

    // Un solo cap√≠tulo por ahora (el que ya tienes en config)
    config.chapters.forEach((record, idx) => {
      var container = document.createElement('div');
      var chapter = document.createElement('div');

      if (record.title){ var h3 = document.createElement('h3'); h3.textContent = record.title; chapter.appendChild(h3); }
      if (record.description){ var p = document.createElement('p'); p.innerHTML = record.description; chapter.appendChild(p); }

      container.id = record.id; container.classList.add('step'); if(idx===0) container.classList.add('active');
      chapter.classList.add(alignments[record.alignment] || 'righty');
      container.appendChild(chapter); features.appendChild(container);
    });
    story.appendChild(features);

    // ==== Mapa ====
    mapboxgl.accessToken = config.accessToken;
    // En m√≥vil, alejamos un poco el mapa en el primer cap√≠tulo para abarcar m√°s
    (function(){
      try{
        var isMobile = window.matchMedia('(max-width: 768px)').matches;
        if (!isMobile || !config || !Array.isArray(config.chapters)) return;

        function applyMobileOverrides(chapterId, overrides){
          var chapter = config.chapters.find(function(ch){ return ch.id === chapterId; });
          if (!chapter || !chapter.location) return;
          if (overrides.center) chapter.location.center = overrides.center.slice();
          ['zoom','pitch','bearing'].forEach(function(prop){
            if (typeof overrides[prop] === 'number') {
              chapter.location[prop] = overrides[prop];
            }
          });
        }

        var mobileOverrides = {
          'incendios-2025': {
            center: [-7.60, 43.45],
            zoom: 6.2
          },
          'tendencia-aumento': {
            center: [-7.60, 43.45],
            zoom: 6.2
          },
          'galicia-noroeste': {
            center: [-7.395, 42.289],
            zoom: 7.7
          },
          'tendencia-comparativas': {
            center: [-7.60, 43.45],
            zoom: 6.2
          }
        };

        Object.keys(mobileOverrides).forEach(function(key){
          applyMobileOverrides(key, mobileOverrides[key]);
        });
      }catch(e){}
    })();
    var map = new mapboxgl.Map({
      container: 'map',
      style: config.style,
      center: config.chapters[0].location.center,
      zoom: config.chapters[0].location.zoom,
      bearing: config.chapters[0].location.bearing,
      pitch: config.chapters[0].location.pitch,
      interactive: true
    });

    // ==== Scrollama ====
    var scroller = scrollama();

    function getLayerPaintType(layer){ return layerTypes[ map.getLayer(layer).type ]; }
    function setLayerOpacity(entry){
      var props = getLayerPaintType(entry.layer);
      props.forEach(function(prop){
        var opts = {};
        if(entry.duration){
          var tprop = prop + '-transition';
          opts = {duration: entry.duration};
          map.setPaintProperty(entry.layer, tprop, opts);
        }
        map.setPaintProperty(entry.layer, prop, entry.opacity, opts);
      });
    }
    
    // Activaci√≥n temprana de los incendios en m√≥vil: cuando la secci√≥n del mapa se empieza a ver
    function setupEarlyFiresRevealForMobile(){
      try{
        var isMobile = window.matchMedia('(max-width: 768px)').matches;
        if (!isMobile) return;
        var storyEl = document.getElementById('story');
        if (!storyEl) return;
        var revealed = false;
        var observer = new IntersectionObserver(function(entries){
          entries.forEach(function(entry){
            if (!revealed && entry.isIntersecting){
              revealed = true;
              try{
                // Oculta capas por defecto y activa las de incendios del primer cap√≠tulo
                window.hideDefaultLayers();
                var first = (config && config.chapters && config.chapters[0]) ? config.chapters[0] : null;
                if (first && first.onChapterEnter){
                  first.onChapterEnter.forEach(function(ent){
                    if (ent.layer){ setLayerOpacity(ent); }
                  });
                }
              }catch(e){}
              observer.disconnect();
            }
          });
        }, { threshold: 0.01 });
        observer.observe(storyEl);
      }catch(e){}
    }

    map.on('load', function(){
      // Ocultar capas por defecto al cargar el mapa
      window.hideDefaultLayers();
      
      // Asegurar limpieza completa inicial
      CategoryController.hideAll();
      
      // Arrancamos el scroll cuando el mapa est√© listo, usando la funci√≥n que maneja callbacks
      window.enableChapterCallbacks(scroller, config, setLayerOpacity);
      
      // M√≥vil: revelar incendios al empezar a verse la secci√≥n del mapa
      setupEarlyFiresRevealForMobile();
    });

    // ==== CONTROLADOR DE CATEGOR√çAS ====
    
    const mobileViewportQuery = window.matchMedia('(max-width: 768px)');
    const climateAttachmentState = { parent: null, placeholder: null };
    function isMobileViewport(){
        return mobileViewportQuery.matches;
    }
    function placeCategorySelector(){
        const selector = document.getElementById('category-selector');
        if (!selector) return;
        const mobileSlot = document.getElementById('category-mobile-slot');
        const home = document.getElementById('category-selector-home');
        if (isMobileViewport() && mobileSlot) {
            mobileSlot.appendChild(selector);
            selector.classList.add('category-selector-inline');
        } else if (home) {
            home.appendChild(selector);
            selector.classList.remove('category-selector-inline');
        }
    }
    function placeClimateInline(){
        const container = document.getElementById('climate-inline-container');
        const step = document.getElementById('galicia-noroeste');
        if (!container || !step) return;
        if (!climateAttachmentState.parent) {
            climateAttachmentState.parent = container.parentElement;
        }
        if (!climateAttachmentState.placeholder) {
            climateAttachmentState.placeholder = document.createElement('div');
            climateAttachmentState.placeholder.style.display = 'none';
        }
        if (isMobileViewport()) {
            if (container.parentElement !== step) {
                climateAttachmentState.parent.insertBefore(climateAttachmentState.placeholder, container);
                step.appendChild(container);
                container.classList.add('climate-detached');
            }
        } else {
            if (container.parentElement !== climateAttachmentState.parent && climateAttachmentState.parent) {
                climateAttachmentState.parent.insertBefore(container, climateAttachmentState.placeholder);
                if (climateAttachmentState.placeholder.parentElement === climateAttachmentState.parent) {
                    climateAttachmentState.parent.removeChild(climateAttachmentState.placeholder);
                }
                container.classList.remove('climate-detached');
            }
        }
    }
    placeClimateInline();
    
    // Utilidades para manejo de visibilidad
    const CategoryController = {
        
        // Pre-carga de im√°genes
        preloadImages() {
            const images = ['assets/Fases_Clima.png', 'assets/Larouco_Clima.png'];
            images.forEach(src => {
                const img = new Image();
                img.src = src;
            });
        },

        // Oculta todas las capas y overlays con verificaci√≥n robusta
        hideAll(options = {}) {
            const { preserveInline = false } = options;
            const layersToHide = ['XEOURENSE', 'USOURENSE', 'RELIEVE'];
            
            layersToHide.forEach(layerId => {
                try {
                    if (map && map.isStyleLoaded && map.isStyleLoaded() && map.getLayer && map.getLayer(layerId)) {
                        // Verificar si la capa est√° visible antes de cambiarla
                        const visibility = map.getLayoutProperty(layerId, 'visibility');
                        if (visibility !== 'none') {
                            map.setLayoutProperty(layerId, 'visibility', 'none');
                        }
                    }
                } catch (error) {
                    console.warn(`Error ocultando capa ${layerId}:`, error);
                }
            });

            // Tambi√©n asegurar que las capas de fuego est√©n ocultas
            const fireLayerIds = ['FIRES_GLOW_POINT_1', 'FIRES_GLOW_POINT_2', 'FIRES_GLOW_POINT_3', 'FIRES_PERIMETER'];
            fireLayerIds.forEach(layerId => {
                try {
                    if (map && map.isStyleLoaded && map.isStyleLoaded() && map.getLayer && map.getLayer(layerId)) {
                        const props = getLayerPaintType(layerId);
                        props.forEach(prop => {
                            map.setPaintProperty(layerId, prop, 0, { duration: 0 });
                        });
                    }
                } catch (error) {
                    console.warn(`Error ocultando capa de fuego ${layerId}:`, error);
                }
            });

            // Ocultar overlays
            const climateOverlay = document.getElementById('climate-images-overlay');
            if (climateOverlay) {
                climateOverlay.classList.add('hidden');
            }
            const climateInline = document.getElementById('climate-inline-container');
            if (climateInline) {
                if (preserveInline) {
                    climateInline.style.display = 'flex';
                } else {
                climateInline.style.display = 'none';
                }
            }
            
            // Ocultar marcador de Larouco
            window.hideLarouco();
        },

        showCategoryContent(categoryKey, options = {}) {
            const skipHide = options.skipHide;
            if (!skipHide) {
                CategoryController.hideAll();
            }
            
            switch(categoryKey) {
                case 'geologia':
                    CategoryController.showLayerSafe('XEOURENSE');
                    break;
                case 'vegetacion':
                    CategoryController.showLayerSafe('USOURENSE');
                    break;
                case 'clima':
                    CategoryController.showImagesForClima();
                    break;
                case 'geografia':
                    CategoryController.showLayerSafe('RELIEVE');
                    break;
            }
        },
        
        reapplyCategory(categoryKey) {
            if (!categoryKey) return;
            CategoryController.showCategoryContent(categoryKey, { skipHide: true });
        },
        
        // Muestra las im√°genes de clima
        showImagesForClima() {
            const climateOverlay = document.getElementById('climate-images-overlay');
            const climateInline = document.getElementById('climate-inline-container');
            
            if (isMobileViewport()) {
                if (climateOverlay) {
                    climateOverlay.classList.add('hidden');
                }
                if (climateInline) {
                    climateInline.style.display = 'flex';
                }
            } else {
                if (climateInline) {
                    climateInline.style.display = 'none';
                }
                if (climateOverlay) {
                    climateOverlay.classList.remove('hidden');
                }
            }
        },

        // Versi√≥n segura para mostrar capas
        showLayerSafe(layerId, retries = 3) {
            try {
                if (map && map.getLayer && map.getLayer(layerId)) {
                    map.setLayoutProperty(layerId, 'visibility', 'visible');
                } else if (retries > 0) {
                    // Reintentar si la capa no est√° disponible
                    setTimeout(() => {
                        this.showLayerSafe(layerId, retries - 1);
                    }, 100);
                }
            } catch (error) {
                console.warn(`Error mostrando capa ${layerId}:`, error);
                if (retries > 0) {
                    setTimeout(() => {
                        this.showLayerSafe(layerId, retries - 1);
                    }, 200);
                }
            }
        },

        // Verifica si el mapa est√° listo con m√∫ltiples checks
        isMapReady() {
            return map && 
                   map.isStyleLoaded && 
                   map.isStyleLoaded() && 
                   map.loaded && 
                   map.loaded();
        }
    };

    // Estado actual del selector
    let currentCategory = null;
    window.__afterHideDefaultLayers = function(){
        try{
            const chapter = document.getElementById('galicia-noroeste');
            if (chapter && chapter.classList.contains('active') && currentCategory){
                CategoryController.reapplyCategory(currentCategory);
            }
        }catch(e){}
    };

    // Contenido de cada categor√≠a (placeholders)
    const categoryContent = {
        geologia: {
    title: 'Geolog√≠a',
    text: '<h2>Geolog√≠a</h2>En esta capa podemos ver la <strong>litolog√≠a</strong> del sureste de Galicia. La mayor parte del territorio est√° compuesta por <strong>rocas metam√≥rficas</strong> y <strong>gran√≠ticas</strong>, que dan lugar a <strong>suelos √°cidos</strong>.<br>Estos suelos favorecen comunidades de plantas m√°s <strong>inflamables</strong>, debido a la composici√≥n de sus tejidos.<br><br><strong>Leyenda:</strong><br><span style="color: #e7298a;">‚ñ†</span> DEP√ìSITOS DETR√çTICOS CUATERNARIOS<br><span style="color: #1b9e77;">‚ñ†</span> DEP√ìSITOS DETR√çTICOS TERCIARIOS<br><span style="color: #e6ab02;">‚ñ†</span> DEP√ìSITOS PLIOCUATERNARIOS<br><span style="color: #8cf0b7;">‚ñ†</span> ROCAS CARBONATADAS<br><span style="color: #51e723;">‚ñ†</span> ROCAS FILONIANAS<br><span style="color: #d95f02;">‚ñ†</span> ROCAS GRAN√çTICAS<br><span style="color: #7570b3;">‚ñ†</span> ROCAS METAM√ìRFICAS<br><br><div style="text-align: right; font-style: italic; color: #666; font-size: 12px;">Fuente: SERGAS</div>'
},

        vegetacion: {
    title: 'Vegetaci√≥n',
    text: '<h2>Vegetaci√≥n</h2>Esta capa muestra los <strong>usos del suelo</strong> en el sureste de Galicia. Destaca el claro predominio del <strong>matorral</strong>, muy por encima de otros usos como el <strong>mosaico agroforestal</strong>, las <strong>zonas de cultivo</strong> o los peque√±os <strong>bosques</strong> y <strong>plantaciones forestales</strong>. Esta distribuci√≥n es clave para entender la cantidad y la continuidad del <strong>combustible vegetal</strong>, factores decisivos en la propagaci√≥n de los incendios.<br><br><strong>Leyenda:</strong><br><span style="color: #a6cee3;">‚ñ†</span> MOSAICO AGROFORESTAL<br><span style="color: #1f78b4;">‚ñ†</span> TURBERA<br><span style="color: #b2df8a;">‚ñ†</span> PLANTACI√ìN FORESTAL<br><span style="color: #33a02c;">‚ñ†</span> BOSQUE<br><span style="color: #fb9a99;">‚ñ†</span> AGROSISTEMA EXTENSIVO<br><span style="color: #e31a1c;">‚ñ†</span> SUPERFICIE DE CULTIVO<br><span style="color: #fdbf6f;">‚ñ†</span> MATORRAL Y ROCAS<br><span style="color: #ff7f00;">‚ñ†</span> EXTRACTIVO<br><span style="color: #cab2d6;">‚ñ†</span> VI√ëEDO<br><br><div style="text-align: right; font-style: italic; color: #666; font-size: 12px;">Fuente: SERGAS</div>'
},

        clima: {
    title: 'Clima',
    text: '<h2>Clima</h2>Este gr√°fico muestra las <strong>precipitaciones</strong>, la <strong>temperatura</strong> y el <strong>NDVI</strong> (un √≠ndice que mide la actividad de la vegetaci√≥n) registrados en la estaci√≥n de <strong>Larouco</strong>, en la zona del incendio.<br><br>Se observan dos fases bien definidas:<br><br>üåß <strong>Estaci√≥n lluviosa</strong>: abundantes lluvias y temperaturas moderadas reducen el riesgo de incendio mientras favorecen una alta productividad vegetal y la acumulaci√≥n de biomasa.<br><br>‚òÄÔ∏è <strong>Estaci√≥n seca</strong>: con el aumento prolongado de las temperaturas se aprecia una ca√≠da del <strong>NDVI</strong> ‚Äîla vegetaci√≥n se seca‚Äî, la reserva de combustible es elevada y el riesgo de incendio se dispara.<br><br>Este patr√≥n encaja con <strong>climas mediterr√°neo lluvioso</strong>, <strong>tropical estacional</strong> o ciertos <strong>climas continentales</strong>, donde el fuego es parte de la din√°mica natural del ecosistema.'
},

        geografia: {
    title: 'Geograf√≠a',
    text: '<h2>Geograf√≠a</h2>En el mapa se aprecia un <strong>relieve monta√±oso y muy recortado</strong>, con valles profundos y laderas escarpadas que caracterizan buena parte del interior de Galicia.<br><br>La <strong>geograf√≠a</strong> influye de forma decisiva en el comportamiento del fuego:<br><br><strong>Relieve abrupto</strong>: las pendientes dificultan el acceso de los equipos de extinci√≥n y facilitan que las llamas asciendan con rapidez.<br><br><strong>Vientos irregulares y fuertes</strong>: en zonas monta√±osas las corrientes de aire cambian de direcci√≥n con facilidad, lo que puede desviar bruscamente el avance del incendio.'
}

    };

    // Funci√≥n para actualizar la explicaci√≥n de la capa
    function updateLayerExplanation(categoryKey) {
        const descriptionElement = document.getElementById('layer-description');
        
        if (descriptionElement) {
            if (categoryContent && categoryContent[categoryKey]) {
                descriptionElement.innerHTML = categoryContent[categoryKey].text;
            } else {
                descriptionElement.innerHTML = 'Selecciona una categor√≠a para conocer c√≥mo influye en la propagaci√≥n del fuego.';
            }
        }
    }

    // Controlador principal de categor√≠as
    function setCategory(category) {
        // Prevenir m√∫ltiples ejecuciones simult√°neas
        if (setCategory.isProcessing) {
            return;
        }
        setCategory.isProcessing = true;
        
        try {
            // Si el mapa no est√° listo, esperar
            if (!CategoryController.isMapReady()) {
                map.once('idle', () => {
                    setCategory.isProcessing = false;
                    setCategory(category);
                });
                return;
            }

            // Actualizar inmediatamente estado visual de botones y explicaci√≥n
            updateCategoryButtons(category);
            updateLayerExplanation(category);
            
            // Peque√±a pausa para asegurar que las capas se oculten antes de mostrar nuevas
            setTimeout(() => {
                CategoryController.showCategoryContent(category);
                currentCategory = category;
                setCategory.isProcessing = false;
            }, 50);
            
        } catch (error) {
            console.error('Error en setCategory:', error);
            setCategory.isProcessing = false;
        }
    }

    // Actualiza el estado visual de los botones
    function updateCategoryButtons(activeCategory) {
        const buttons = document.querySelectorAll('.category-tab');
        
        buttons.forEach((button, index) => {
            const category = button.getAttribute('data-category');
            const isActive = category === activeCategory;
            
            button.setAttribute('aria-pressed', isActive.toString());
            button.setAttribute('tabindex', isActive ? '0' : '-1');
        });
    }

    // Navegaci√≥n con teclado entre categor√≠as
    function navigateCategories(direction) {
        const buttons = Array.from(document.querySelectorAll('.category-tab'));
        const currentIndex = buttons.findIndex(btn => btn.getAttribute('aria-pressed') === 'true');
        const nextIndex = Math.max(0, Math.min(buttons.length - 1, currentIndex + direction));
        
        if (nextIndex !== currentIndex) {
            buttons[nextIndex].focus();
            const category = buttons[nextIndex].getAttribute('data-category');
            setCategory(category);
        }
    }

    // Inicializar eventos del selector
    function initCategorySelector() {
        CategoryController.preloadImages();
        
        const buttons = document.querySelectorAll('.category-tab');
        
        buttons.forEach(button => {
            // Click events simplificados - sin debounce problem√°tico
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Solo procesar si no est√° ya procesando
                if (!setCategory.isProcessing) {
                    const category = button.getAttribute('data-category');
                    setCategory(category);
                }
            });
            
            // Prevenir doble click
            button.addEventListener('dblclick', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            // Keyboard events
            button.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const category = button.getAttribute('data-category');
                    setCategory(category);
                }
                
                // Arrow navigation
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateCategories(e.key === 'ArrowRight' ? 1 : -1);
                }
            });
        });

        // El contenedor de clima ya no necesita click fuera para cerrarse
        // Se cierra autom√°ticamente al cambiar de categor√≠a
    }

    function handleViewportCategoryPlacement(){
        const selector = document.getElementById('category-selector');
        if (selector && selector.style.display !== 'none') {
            placeCategorySelector();
        }
        if (currentCategory === 'clima') {
            CategoryController.showImagesForClima();
        }
        placeClimateInline();
    }
    if (mobileViewportQuery && mobileViewportQuery.addEventListener) {
        mobileViewportQuery.addEventListener('change', handleViewportCategoryPlacement);
    } else if (mobileViewportQuery && mobileViewportQuery.addListener) {
        mobileViewportQuery.addListener(handleViewportCategoryPlacement);
    }
    
    // Callbacks para integraci√≥n con cap√≠tulos
    window.showCategorySelector = function() {
        const selector = document.getElementById('category-selector');
        if (!selector) return;
        placeCategorySelector();
        selector.style.display = 'flex';
        selector.classList.remove('category-selector-hidden');
    };

    window.hideCategorySelector = function() {
        const isMobile = isMobileViewport();
        const hasSelection = !!currentCategory;
        const preserveInline = isMobile && hasSelection && currentCategory === 'clima';
        const preserveState = isMobile && hasSelection;
        
        // Forzar limpieza de capas, pero conservar el contenido ya desplegado en m√≥vil para evitar saltos
        CategoryController.hideAll({ preserveInline });
        
        if (!preserveState) {
            updateCategoryButtons(null);
            updateLayerExplanation(null);
            currentCategory = null;
        }
        
        // Detener cualquier procesamiento del selector de categor√≠as
        if (setCategory.isProcessing) {
            setCategory.isProcessing = false;
        }
        
        const selector = document.getElementById('category-selector');
        if (!selector) return;
        if (isMobile) {
            selector.classList.add('category-selector-hidden');
        } else {
            const home = document.getElementById('category-selector-home');
            if (home) {
                home.appendChild(selector);
            }
            selector.classList.remove('category-selector-inline');
            selector.style.display = 'none';
            updateCategoryButtons(null);
            updateLayerExplanation(null);
            currentCategory = null;
        }
        
        // Asegurar que todas las capas problem√°ticas est√©n ocultas
        ['XEOURENSE', 'USOURENSE', 'RELIEVE', 'FIRES_GLOW_POINT_1', 'FIRES_GLOW_POINT_2', 'FIRES_GLOW_POINT_3', 'FIRES_PERIMETER'].forEach(layerId => {
            try {
                if (map && map.isStyleLoaded && map.isStyleLoaded() && map.getLayer && map.getLayer(layerId)) {
                    if (layerId.startsWith('FIRES_')) {
                        const props = getLayerPaintType(layerId);
                        props.forEach(prop => {
                            map.setPaintProperty(layerId, prop, 0, { duration: 0 });
                        });
                    } else {
                        map.setLayoutProperty(layerId, 'visibility', 'none');
                    }
                }
            } catch (error) {
                console.warn(`Error en limpieza forzada de capa ${layerId}:`, error);
            }
        });
        
        // Ocultar marcador
        window.hideLarouco();
    };

    // Auto-inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', initCategorySelector);
  </script>
  <!-- HERO FINAL (fuera de Scrollama) -->
  <section id="hero-final" aria-label="Cierre">
    <div class="hero-inner">
      <h1 class="hero-headline">
        Debemos aprender a convivir con el fuego, pero podemos hacer m√°s‚Ä¶
      </h1>
      <div class="hero-kicker" style="text-align:left">
        Pero me temo que no hay tal varita m√°gica. Hay que aceptar que el fuego seguir√° formando parte de la realidad, cada vez m√°s con el cambio clim√°tico.<br><br>
        La prioridad: reducir su impacto y adaptarnos, m√°s que buscar culpables f√°ciles.<br><br>
        La respuesta es compleja, y requiere visi√≥n a largo plazo: m√°s gesti√≥n del paisaje, m√°s pastoreo adaptativo, prevenci√≥n activa en la interfaz urbano-forestal, educaci√≥n para la convivencia con el fuego‚Ä¶ y mucho m√°s.<br><br>
        El fuego es un fen√≥meno natural: frecuentemente negativo y tr√°gico para personas, bienes y modos de vida, pero a menudo positivo para el rejuvenecimiento y la din√°mica de los ecosistemas.<br><br>
        Entenderlo es clave para aprender a convivir con √©l.
      </div>
    </div>
    <div class="photo-credit">FOTO: Pedro Armestre</div>
  </section>
  <script>
    (function () {
      var topbar = document.getElementById('topbar');
      if (!topbar) return;
      var lastY = window.scrollY || 0;
      var hidden = false;
      var minDelta = 6;
      window.addEventListener('scroll', function () {
        var y = window.scrollY || 0;
        var delta = y - lastY;
        if (window.matchMedia('(max-width: 768px)').matches) {
          if (delta > minDelta && y > 10 && !hidden) {
            topbar.classList.add('topbar-hide');
            hidden = true;
          } else if (delta < -minDelta || y <= 10) {
            topbar.classList.remove('topbar-hide');
            hidden = false;
          }
        } else {
          // Visible siempre en desktop
          topbar.classList.remove('topbar-hide');
          hidden = false;
        }
        lastY = y;
      }, { passive: true });
    })();
  </script>
</body>
</html>

