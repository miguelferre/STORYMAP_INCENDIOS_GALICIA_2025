<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Incendios en Galicia ‚Äî StoryMap</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.8.0/mapbox-gl.js"></script>
  <script src="https://unpkg.com/scrollama"></script>
  <style>
    :root{
      --ink:#ffffff;
      --panel:#041138;
      --glass-bg: rgba(25,25,25,0.55);
      --glass-brd: rgba(255,255,255,0.08);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink);background:#0b0b0b}

    /* Mapa fijo detr√°s */
    #map{position:fixed;inset:0;width:100vw;height:100vh}

   /* Topbar estilo ‚Äúcabecera editorial‚Äù */
#topbar{
  position:fixed; 
  top:0; left:0; right:0; 
  height:56px;
  background:#041138d4; 
  backdrop-filter: blur(4px);
  display:flex; 
  align-items:center; 
  z-index:10;
  padding:0 16px; 
  border-bottom:1px solid #041138;
}

/* Unificamos fuente y peso */
#brand, #titleRight{
  font-weight:700; 
  letter-spacing:.2px;
  font-family: inherit;
}

/* Mandamos la descripci√≥n a la derecha */
#titleRight{
  margin-left:auto;
}


#spacer{ display:none; }

/* HERO  */
#hero{
  position:relative; z-index:9;
  min-height:100vh; width:100%;
  display:flex; flex-direction:column;
  justify-content:flex-start;   /* subimos el contenido */
  align-items:center;
  padding-top:18vh;             /* controlamos la altura inicial */
  background-image: url('./assets/Imagen_quemado.webp');
  background-size:cover; 
  background-position:center;
  box-shadow: inset 0 -200px 200px rgba(0,0,0,.35);
}

.hero-inner{
  width:min(1100px,92vw);
  margin-top:500;  
}

.hero-headline{
  font-size: clamp(32px, 6.4vw, 70px);
  line-height:1.05; 
  font-weight:900; 
  text-align:center;
  text-shadow: 0 6px 30px rgba(0,0,0,.45);
  margin:0;  
}

.hero-kicker{
  width:min(780px, 92vw);
  margin:40px auto 0 auto;  
  background: var(--panel);
  color:#fff; 
  border-radius:10px;
  font-size: 20px;
  padding:18px 22px; 
  line-height:1.45;
  box-shadow: 0 8px 26px rgba(0,0,0,.35);
  text-align:center;
}



    /* Indicador de scroll */
    .scroll-hint{
      position:absolute; left:50%; transform:translateX(-50%);
      bottom:28px; font-size:13px; opacity:.9;
      background:rgba(0,0,0,.5); padding:6px 10px; border-radius:16px;
      border:1px solid rgba(255,255,255,.08)
    }
    /* Cr√©ditos de foto y fuentes */
    .photo-credit, .map-source {
        font-size: 9px;
        color: rgba(255, 255, 255, 0.445);
        font-style: italic;
        pointer-events: none; /* no molesta a los clics */
        bottom: 10px;
    }
    .photo-credit {
        position: absolute;
        right: 14px;
        z-index: 11;
    }
    .map-source {
        position: absolute;
        left: 100px;
        z-index: 3;  /* Por debajo del hero pero por encima del mapa */
    }
    .map-source.fixed {
        position: fixed;
    }



    /* Contenedor de la historia (cap√≠tulos) */
    #story{position:relative; z-index:5}
    #features{padding-top:30vh; padding-bottom:10vh}

    /* Tarjetas de cap√≠tulo (panel derecha) */
    .step{padding-bottom:45vh; opacity:.35}
    .step.active{opacity:.98}
    
    /* Contenedor base del cap√≠tulo sin fondo espec√≠fico */
    .step > div.lefty, .step > div.righty, .step > div.centered, .step > div.fully {
      border-radius:12px; padding:18px 20px;
      line-height:1.45; font-size:14px; color:#f0f0f0;
    }
    
    /* Solo los p√°rrafos y encabezados obtienen el fondo opaco */
    .step h3, .step p {
      background: var(--glass-bg);
      border:1px solid var(--glass-brd);
      backdrop-filter: blur(4px);
      border-radius:8px; 
      padding:12px 16px;
      margin: 8px 0;
    }
    h3{margin:0 0 8px 0; font-size:18px}


    .lefty {
      width: 33vw;
      margin-left: 5vw;
    }
    
    .righty {
      width: 57vw;
      margin-left: 38vw;
    }

    .fully {
      width: 90vw;
      margin-left: 5vw;
    }

    /* Nueva clase espec√≠fica para el cap√≠tulo de tendencias */
    .chapter-wide {
      width: 84vw !important;
      margin-left: 4vw !important;  /* mismo margen que .lefty */
      position: relative !important;
    }

    @media (max-width: 1200px){  /* Ajustado el breakpoint para pantallas m√°s grandes */
      .lefty, .righty { 
        width: 90vw; 
        margin: 0 auto; 
      }
      #topbar{
        height:auto; 
        padding:10px 12px; 
        gap:8px; 
        align-items:flex-start
      }
      #spacer{display:none}
      #titleCenter{text-align:left}
      .hero-headline{margin-top:12vh}
    }
    /* Selector de categor√≠as */
    .category-selector {
        position: fixed;
        top: 56px; /* Debajo del topbar */
        left: 0;
        right: 0;
        z-index: 8;
        display: none; /* Inicialmente oculto */
        justify-content: center;
        padding: 12px 20px;
        background: rgba(15, 23, 51, 0.85);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .category-tabs {
        display: flex;
        gap: 8px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
        padding: 4px;
    }

    .category-tab {
        padding: 10px 20px;
        background: transparent;
        color: rgba(255, 255, 255, 0.7);
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        white-space: nowrap;
    }

    .category-tab:hover {
        background: rgba(255, 255, 255, 0.1);
        color: rgba(255, 255, 255, 0.9);
    }

    .category-tab[aria-pressed="true"] {
        background: rgba(73, 123, 179, 0.9);
        color: white;
        box-shadow: 0 2px 8px rgba(73, 123, 179, 0.3);
    }

    .category-tab:focus {
        outline: 2px solid rgba(73, 123, 179, 0.8);
        outline-offset: 2px;
    }



    /* Overlay de im√°genes de clima */
    .climate-images-overlay {
        position: fixed;
        top: 120px;
        right: 20px;
        width: 850px;
        max-height: calc(100vh - 140px);
        z-index: 7;
        background: rgba(15, 23, 51, 0.92);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 20px;
        overflow-y: auto;
        transition: all 0.4s ease;
    }

    .climate-images-overlay.hidden {
        opacity: 0;
        visibility: hidden;
        transform: translateX(20px);
    }

    .climate-images-container {
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-items: center;
    }

    .climate-images-container img {
        height: auto;
        object-fit: contain;
        border-radius: 8px;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
    }

    .climate-img-small {
        width: 100%;
        max-width: 400px;
    }

    .climate-img-large {
        width: 100%;
        max-width: 760px;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .category-selector {
            padding: 8px 12px;
        }
        
        .category-tab {
            padding: 8px 16px;
            font-size: 13px;
        }
        
        .category-text-overlay {
            left: 12px;
            right: 12px;
            width: auto;
            top: 100px;
        }
        
        .climate-images-overlay {
            left: 12px;
            right: 12px;
            width: auto;
            top: 100px;
        }
        
        .climate-img-large {
            max-width: 100%;
        }
        
        .climate-img-small {
            max-width: 70%;
        }
        
        .climate-images-container {
            gap: 12px;
        }
        
        .climate-images-container img {
            max-width: 80%;
        }
    }

    @media (max-width: 480px) {
        .category-tabs {
            gap: 4px;
            padding: 2px;
        }
        
        .category-tab {
            padding: 6px 12px;
            font-size: 12px;
        }
    }

    /* Utility class */
    .hidden {
        opacity: 0 !important;
        visibility: hidden !important;
    }

    /* Hero final fuera de Scrollama */
    #hero-final{
      position:relative; z-index:9;
      min-height:100vh; width:100%;
      display:flex; flex-direction:column;
      justify-content:flex-start;
      align-items:center;
      padding-top:18vh;
      background-image: url('./assets/Esperanza.webp');
      background-size:cover; 
      background-position:center;
      box-shadow: inset 0 -200px 200px rgba(0,0,0,.35);
    }

    /* Slider vertical para comparaci√≥n de im√°genes Cimadevila */
    .vertical-slider-container {
        width: 100%;
        max-width: 100%;
        margin: 0 auto;
    }

    .vertical-slider-wrapper {
        position: relative;
        width: 100%;
        max-width: 100%;
        aspect-ratio: 4 / 3; /* Ajustar seg√∫n tus im√°genes */
        overflow: hidden;
        border-radius: 12px;
        box-shadow: 0 8px 26px rgba(0, 0, 0, 0.35);
        cursor: ns-resize;
    }

    .vertical-slider-img {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    .vertical-slider-img-bottom {
        z-index: 1;
    }

    .vertical-slider-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        z-index: 2;
        clip-path: inset(0 0 50% 0);
        will-change: clip-path;
        transform: translateZ(0); /* Aceleraci√≥n GPU */
    }

    .vertical-slider-overlay.dragging {
        transition: none; /* Sin transici√≥n durante el drag */
    }

    .vertical-slider-img-top {
        z-index: 3;
    }

    .vertical-slider-handle {
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 4px;
        margin: 0;
        z-index: 10;
        cursor: ns-resize;
        transform: translateY(-50%) translateZ(0); /* Aceleraci√≥n GPU */
        pointer-events: none;
        will-change: top;
    }

    .vertical-slider-handle-icon {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.95);
        border: 3px solid #F44E11;
        cursor: grab;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        transition: all 0.2s ease;
        pointer-events: all;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .vertical-slider-handle-icon::before {
        content: '‚ò∞';
        font-size: 16px;
        color: #F44E11;
        line-height: 1;
    }

    .vertical-slider-handle-icon:hover {
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5);
    }

    .vertical-slider-handle-icon:active {
        cursor: grabbing;
        transform: translate(-50%, -50%) scale(0.95);
    }

    .vertical-slider-labels {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        flex-direction: column;
        gap: 20px;
        z-index: 5;
        pointer-events: none;
        width: 100%;
        height: 100%;
        justify-content: space-between;
        padding: 16px 0;
    }

    .vertical-slider-label-top,
    .vertical-slider-label-bottom {
        background: none;
        color: white;
        padding: 0;
        border-radius: 0;
        font-size: 48px;
        font-weight: 700;
        white-space: nowrap;
        backdrop-filter: none;
        text-align: center;
        align-self: center;
        text-shadow: 0 1px 3px rgba(255, 255, 255, 0.6),
                     0 2px 6px rgba(255, 255, 255, 0.4);
    }

    .vertical-slider-label-top {
        order: 1;
    }

    .vertical-slider-label-bottom {
        order: 2;
    }

    /* L√≠nea indicadora en el slider */
    .vertical-slider-handle::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 0;
        width: 100%;
        height: 2px;
        background: rgba(244, 78, 17, 0.6);
        z-index: -1;
        transform: translateY(-50%);
        pointer-events: none;
    }

    @media (max-width: 768px) {
        .vertical-slider-handle-icon {
            width: 32px;
            height: 32px;
        }

        .vertical-slider-handle-icon::before {
            font-size: 14px;
        }

        .vertical-slider-labels {
            padding: 12px 0;
        }

        .vertical-slider-label-top,
        .vertical-slider-label-bottom {
            font-size: 36px;
        }
    }

    @media (max-width: 480px) {
        .vertical-slider-label-top,
        .vertical-slider-label-bottom {
            font-size: 28px;
        }
    }
  </style>
</head>
<script>
window.addEventListener('load', () => {
  // üîπ Tama√±o del incendio de Larouco‚ÄìSeadur (2025): 31.700 ha ‚âà 317 km¬≤
  const FIRE_KM2 = 317;

  // Utilidades
  const fmt = n => (Math.round(n * 100) / 100).toLocaleString('es-ES');

  // ‚Äî‚Äî‚Äî UI refs (el comparador est√° en el description del cap√≠tulo o en el HTML) ‚Äî‚Äî‚Äî
  function els() {
    return {
      select: document.getElementById('city'),
      out: document.getElementById('result'),
      fireCircle: document.getElementById('fire-circle'),
      cityCircle: document.getElementById('city-circle'),
      circleLabel: document.getElementById('circle-label'),
    };
  }

  // ‚Äî‚Äî‚Äî Dibuja/actualiza c√≠rculos conc√©ntricos ‚Äî‚Äî‚Äî
  function updateCircles(cityName, cityKm2) {
    const largeCircle = document.getElementById('large-circle');
    const smallCircle = document.getElementById('small-circle');
    const circleLabel = document.getElementById('circle-label');
    if (!largeCircle || !smallCircle || !circleLabel) return;

    const svgSize = 300;
    const maxR = (svgSize / 2) - 10;
    const SCALE = 6;

    const fireR = Math.sqrt(FIRE_KM2) * SCALE;
    const cityR = Math.sqrt(cityKm2) * SCALE;
    const factor = Math.min(1, maxR / Math.max(fireR, cityR));

    // Determinar cu√°l es m√°s grande
    if (FIRE_KM2 >= cityKm2) {
      // El fuego es m√°s grande -> va atr√°s
      largeCircle.setAttribute('fill', '#F44E11');
      largeCircle.setAttribute('stroke', '#F44E11');
      smallCircle.setAttribute('fill', 'rgb(0,120,255)');
      smallCircle.setAttribute('stroke', 'rgba(0,120,255,0.5)');
      largeCircle.setAttribute('r', fireR * factor);
      smallCircle.setAttribute('r', cityR * factor);
    } else {
      // La ciudad es m√°s grande -> va atr√°s
      largeCircle.setAttribute('fill', 'rgb(0,120,255)');
      largeCircle.setAttribute('stroke', 'rgb(0,120,255)');
      smallCircle.setAttribute('fill', '#F44E11');
      smallCircle.setAttribute('stroke', '#F44E11');
      largeCircle.setAttribute('r', cityR * factor);
      smallCircle.setAttribute('r', fireR * factor);
    }
    circleLabel.innerHTML = `<span style="color: #F44E11">Incendio (${fmt(FIRE_KM2)} km¬≤)</span> vs <span style="color: rgb(0,120,255)">${cityName} (${fmt(cityKm2)} km¬≤)</span>`;
  }

  // ‚Äî‚Äî‚Äî Texto comparativo ‚Äî‚Äî‚Äî
  function updateText(city) {
    const { out } = els();
    if (!out) return;

    if (FIRE_KM2 >= city.km2) {
      const times = FIRE_KM2 / city.km2;
      out.textContent = `El √°rea quemada equivale a ${fmt(times)} veces el √°rea municipal de ${city.name} (${fmt(FIRE_KM2)} km¬≤ vs ${fmt(city.km2)} km¬≤).`;
    } else {
      const percent = (FIRE_KM2 / city.km2) * 100;
      out.textContent = `El √°rea quemada equivale al ${fmt(percent)}% del √°rea municipal de ${city.name} (${fmt(FIRE_KM2)} km¬≤ vs ${fmt(city.km2)} km¬≤).`;
    }
  }

  // ‚Äî‚Äî‚Äî Cargar CSV y montar la UI ‚Äî‚Äî‚Äî
  fetch('./assets/cities.csv?v=6')   // sube el n√∫mero si actualizas el CSV para evitar cach√©
    .then(r => {
      if (!r.ok) throw new Error(`HTTP ${r.status} al cargar assets/cities.csv`);
      return r.text();
    })
    .then(txt => {
      // Parse CSV muy tolerante (ignora l√≠neas vac√≠as)
      const rows = txt.split(/\r?\n/).map(l => l.trim()).filter(Boolean);
      if (!rows.length) throw new Error('CSV vac√≠o');

      const headers = rows.shift().split(',').map(h => h.trim());
      const nameIdx = headers.indexOf('name');
      const kmIdx   = headers.indexOf('km2');
      if (nameIdx < 0 || kmIdx < 0) throw new Error('CSV debe tener columnas "name" y "km2"');

      const cities = rows.map(line => {
        const cols = line.split(',');
        return { name: (cols[nameIdx] || '').trim(), km2: parseFloat((cols[kmIdx] || '').trim()) };
      }).filter(c => c.name && Number.isFinite(c.km2));

      const { select } = els();
      if (!select) {
        console.warn('No se encontr√≥ <select id="city">. ¬øInsertaste el comparador en el description del cap√≠tulo o en el HTML?');
        return;
      }

      // Rellenar <select> plano (sin grupos)
      cities.forEach(c => {
        const o = document.createElement('option');
        o.value = c.name;
        o.textContent = c.name;
        select.appendChild(o);
      });

      // Ocultar el contenedor de c√≠rculos inicialmente
      document.getElementById('circle-compare').style.display = 'none';

      // Evento cambio
      select.addEventListener('change', () => {
        const city = cities.find(x => x.name === select.value);
        const { out, fireCircle, cityCircle, circleLabel } = els();
        const circleContainer = document.getElementById('circle-compare');
        
        if (!city) {
          // Si no hay ciudad seleccionada, limpiar la visualizaci√≥n
          if (out) out.textContent = '';
          if (circleContainer) circleContainer.style.display = 'none';
          return;
        }
        
        // Mostrar el contenedor de c√≠rculos
        if (circleContainer) circleContainer.style.display = 'block';
        updateText(city);
        updateCircles(city.name, city.km2);
      });

      // A√±adir opci√≥n vac√≠a al inicio
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'Selecciona una ciudad';
      select.insertBefore(emptyOption, select.firstChild);
      select.value = '';
    })
    .catch(err => {
      console.error(err);
      const { out } = els();
      if (out) out.textContent = 'No se pudo cargar la lista de ciudades.';
    });
});
</script>
<style>
  /* Estilo de la etiqueta (solo texto) */
  .map-label{
    color:rgba(255,255,255,0.85); font-weight:700; font-size:14px; 
    text-shadow:0 0 6px rgba(0,0,0,.7);
    background:rgba(0,0,0,.35); padding:2px 6px; border-radius:4px;
    white-space:nowrap; user-select:none;
  }
</style>

<script>
  // 1) Crear la etiqueta como marcador HTML, pero NO a√±adirla a√∫n
  let laroucoMarker = null;
  function createLaroucoLabel() {
    const el = document.createElement('div');
    el.className = 'map-label';
    el.innerHTML = '<span style="opacity: 0.65">Larouco‚ÄìSeadur<br><span style="font-size: 0.9em">(2025)</span></span>';
    el.style.textAlign = 'center';
    laroucoMarker = new mapboxgl.Marker({ element: el, anchor: 'center' });
  }

  // 2) Funciones globales para mostrar/ocultar (las llamaremos desde el cap√≠tulo)
  window.showLarouco = function(delayMs = 0){
    if (!window.map || !map.isStyleLoaded()) return;
    
    // Primero asegurar que est√© oculto antes de mostrarlo
    window.hideLarouco();
    
    if (!laroucoMarker) createLaroucoLabel();
    const coords = [-7.08, 42.65];        // [lng, lat] aprox. Larouco‚ÄìSeadur
    
    const doAdd = () => {
      try {
        if (laroucoMarker && map.isStyleLoaded()) {
          laroucoMarker.setLngLat(coords).addTo(map);
        }
      } catch(error) {
        console.warn('Error mostrando marcador Larouco:', error);
      }
    };
    
    delayMs ? setTimeout(doAdd, delayMs) : doAdd();
  };
  
  window.hideLarouco = function(){
    if (laroucoMarker) { 
      try { 
        laroucoMarker.remove(); 
      } catch(e) {
        console.warn('Error ocultando marcador Larouco:', e);
      }
    }
  };

  // Ajustar padding inferior del contenedor de cap√≠tulos al entrar/salir del hero final
  window.tightenFinalHero = function(){
    try{
      const features = document.getElementById('features');
      if (features) features.style.paddingBottom = '0';
    } catch(e) {}
  };
  window.resetStoryPadding = function(){
    try{
      const features = document.getElementById('features');
      if (features) features.style.paddingBottom = '10vh';
    } catch(e) {}
  };

  // Ocultar/mostrar atribuciones y controles del mapa para el hero final
  let prevBottomLeftDisplay = null;
  let prevBottomRightDisplay = null;
  window.hideMapAttribution = function(){
    try{
      const bl = document.querySelector('.mapboxgl-ctrl-bottom-left');
      const br = document.querySelector('.mapboxgl-ctrl-bottom-right');
      if (bl){ prevBottomLeftDisplay = bl.style.display; bl.style.display = 'none'; }
      if (br){ prevBottomRightDisplay = br.style.display; br.style.display = 'none'; }
    } catch(e) {}
  };
  window.showMapAttribution = function(){
    try{
      const bl = document.querySelector('.mapboxgl-ctrl-bottom-left');
      const br = document.querySelector('.mapboxgl-ctrl-bottom-right');
      if (bl){ bl.style.display = prevBottomLeftDisplay || ''; }
      if (br){ br.style.display = prevBottomRightDisplay || ''; }
    } catch(e) {}
  };

  // Funciones para controlar capas ocultas por defecto
  window.hideDefaultLayers = function() {
    if (config.hiddenLayers && window.map) {
      config.hiddenLayers.forEach(layerId => {
        try {
          if (map.getLayer(layerId)) {
            map.setLayoutProperty(layerId, 'visibility', 'none');
          }
        } catch (error) {
          console.warn(`Error ocultando capa por defecto ${layerId}:`, error);
        }
      });
    }
    
    // Tambi√©n asegurar que las capas de fuego est√©n ocultas cuando se llama esta funci√≥n
    const fireLayerIds = ['FIRES_GLOW_POINT_1', 'FIRES_GLOW_POINT_2', 'FIRES_GLOW_POINT_3', 'FIRES_PERIMETER'];
    fireLayerIds.forEach(layerId => {
      try {
        if (map.getLayer(layerId)) {
          const props = getLayerPaintType(layerId);
          props.forEach(prop => {
            map.setPaintProperty(layerId, prop, 0, { duration: 0 });
          });
        }
      } catch (error) {
        console.warn(`Error ocultando capa de fuego ${layerId}:`, error);
      }
    });
    
    // Ocultar tambi√©n el marcador de Larouco
    window.hideLarouco();
  };

  // Funciones para mostrar capas espec√≠ficas cuando las necesites
  window.showRelieve = function() {
    if (window.map && map.getLayer('RELIEVE')) {
      map.setLayoutProperty('RELIEVE', 'visibility', 'visible');
    }
  };

  window.showUsourense = function() {
    if (window.map && map.getLayer('USOURENSE')) {
      map.setLayoutProperty('USOURENSE', 'visibility', 'visible');
    }
  };

  window.showXeourense = function() {
    if (window.map && map.getLayer('XEOURENSE')) {
      map.setLayoutProperty('XEOURENSE', 'visibility', 'visible');
    }
  };

  // 3) Sistema robusto para manejar transiciones entre cap√≠tulos
  let currentChapterId = null;
  let activeTimers = new Set();
  
  // Funci√≥n para limpiar todos los timers activos
  function clearAllTimers() {
    activeTimers.forEach(timerId => clearTimeout(timerId));
    activeTimers.clear();
  }
  
  // Funci√≥n para limpiar completamente el estado del cap√≠tulo anterior
  function forceCleanupChapter(chapterId) {
    const chapter = config.chapters.find(ch => ch.id === chapterId);
    if (!chapter) return;
    
    // Ejecutar inmediatamente todos los onChapterExit sin delays
    (chapter.onChapterExit || []).forEach(entry => {
      if (entry.layer) {
        // Forzar la opacidad a 0 inmediatamente
        const props = getLayerPaintType(entry.layer);
        props.forEach(prop => {
          map.setPaintProperty(entry.layer, prop, 0, { duration: 0 });
        });
      }
      if (typeof entry.callback === 'function') entry.callback();
      if (typeof entry.callbackName === 'string' && typeof window[entry.callbackName] === 'function') {
        window[entry.callbackName]();
      }
    });
    
    // Limpiar espec√≠ficamente las capas de fuego y Larouco
    if (chapterId === 'incendios-2025') {
      const fireLayerIds = ['FIRES_GLOW_POINT_1', 'FIRES_GLOW_POINT_2', 'FIRES_GLOW_POINT_3', 'FIRES_PERIMETER'];
      fireLayerIds.forEach(layerId => {
        if (map.getLayer(layerId)) {
          const props = getLayerPaintType(layerId);
          props.forEach(prop => {
            map.setPaintProperty(layerId, prop, 0, { duration: 0 });
          });
        }
      });
      window.hideLarouco();
    }
  }

  window.enableChapterCallbacks = function(scroller, config, setLayerOpacity){
    scroller
      .setup({ step: '.step', offset: 0.6, progress: true })
      .onStepEnter(function(response){
        const newChapterId = response.element.id;
        const chapter = config.chapters.find(ch => ch.id === newChapterId);
        
        // Limpiar timers anteriores
        clearAllTimers();
        
        // Si cambiamos de cap√≠tulo, forzar limpieza del anterior
        if (currentChapterId && currentChapterId !== newChapterId) {
          forceCleanupChapter(currentChapterId);
        }
        
        currentChapterId = newChapterId;
        response.element.classList.add('active');
        map[chapter.mapAnimation || 'flyTo'](chapter.location);

        (chapter.onChapterEnter || []).forEach(entry => {
          if (entry.layer) setLayerOpacity(entry);
          if (typeof entry.callback === 'function') entry.callback();
          if (typeof entry.callbackName === 'string' && typeof window[entry.callbackName] === 'function') {
            if (entry.delay && entry.delay > 0) {
              const timerId = setTimeout(() => {
                window[entry.callbackName](entry.delay || 0);
                activeTimers.delete(timerId);
              }, entry.delay);
              activeTimers.add(timerId);
            } else {
              window[entry.callbackName](entry.delay || 0);
            }
          }
        });
      })
      .onStepExit(function(response){
        const exitingChapterId = response.element.id;
        const chapter = config.chapters.find(ch => ch.id === exitingChapterId);
        response.element.classList.remove('active');

        // Ejecutar callbacks de salida con manejo robusto
        (chapter.onChapterExit || []).forEach(entry => {
          if (entry.layer) setLayerOpacity(entry);
          if (typeof entry.callback === 'function') entry.callback();
          if (typeof entry.callbackName === 'string' && typeof window[entry.callbackName] === 'function') {
            if (entry.delay && entry.delay > 0) {
              const timerId = setTimeout(() => {
                window[entry.callbackName](entry.delay || 0);
                activeTimers.delete(timerId);
              }, entry.delay);
              activeTimers.add(timerId);
            } else {
              window[entry.callbackName](entry.delay || 0);
            }
          }
        });
      });
  };

  // Funci√≥n para inicializar el slider vertical de Cimadevila
  window.initCimadevilaSlider = function() {
    const sliderHandle = document.getElementById('cimadevila-slider');
    const overlay = document.querySelector('.vertical-slider-overlay');
    const wrapper = document.querySelector('.vertical-slider-wrapper');
    
    if (!sliderHandle || !overlay || !wrapper) {
      // Si el cap√≠tulo a√∫n no est√° en el DOM, esperar un poco
      setTimeout(() => window.initCimadevilaSlider(), 100);
      return;
    }

    let isDragging = false;
    let currentPercent = 50; // Inicializar en el medio
    let rafId = null;
    let cachedRect = null;
    let needsRectUpdate = true;

    // Funci√≥n optimizada para actualizar el slider usando requestAnimationFrame
    function updateSlider(percent, immediate = false) {
      // Limitar entre 0 y 100
      const newPercent = Math.max(0, Math.min(100, percent));
      
      // Solo actualizar si el valor cambi√≥
      if (Math.abs(newPercent - currentPercent) < 0.01 && !immediate) return;
      
      currentPercent = newPercent;
      
      // Funci√≥n de renderizado optimizada
      function render() {
        const clipValue = `${currentPercent}%`;
        // clip-path: 
        // - percent=0 (arriba): inset(0% 0 0 0) ‚Üí muestra todo el overlay (1957) ‚úì
        // - percent=100 (abajo): inset(100% 0 0 0) ‚Üí oculta overlay, muestra fondo (2021) ‚úì
        // Cuando arrastras hacia abajo (percent aumenta), el clip-path aumenta, ocultando m√°s overlay y mostrando m√°s fondo (2021) ‚úì
        overlay.style.clipPath = `inset(${currentPercent}% 0 0 0)`;
        sliderHandle.style.top = clipValue;
        
        if (wrapper) {
          wrapper.style.setProperty('--slider-line-top', clipValue);
        }
      }
      
      // Usar requestAnimationFrame para suavizar las actualizaciones
      if (immediate) {
        render();
      } else {
        if (rafId !== null) {
          cancelAnimationFrame(rafId);
        }
        rafId = requestAnimationFrame(render);
      }
    }

    // Inicializar en el medio (50%)
    updateSlider(50, true);

    // Cach√© de las dimensiones del wrapper para evitar getBoundingClientRect() repetido
    function getWrapperRect() {
      if (needsRectUpdate || !cachedRect) {
        cachedRect = wrapper.getBoundingClientRect();
        needsRectUpdate = false;
      }
      return cachedRect;
    }

    function getPercentFromEvent(e) {
      const rect = getWrapperRect();
      let clientY;
      if (e.touches && e.touches.length > 0) {
        clientY = e.touches[0].clientY;
      } else {
        clientY = e.clientY;
      }
      const percent = ((clientY - rect.top) / rect.height) * 100;
      return Math.max(0, Math.min(100, percent));
    }

    // Event listeners para el handle y el wrapper completo
    const handleIcon = sliderHandle.querySelector('.vertical-slider-handle-icon');
    
    function startDrag(e) {
      isDragging = true;
      needsRectUpdate = true; // Forzar actualizaci√≥n del rect al iniciar
      e.preventDefault();
      e.stopPropagation();
      
      // Prevenir selecci√≥n de texto mientras se arrastra
      document.body.style.userSelect = 'none';
      document.body.style.cursor = 'ns-resize';
      
      // Desactivar transiciones durante el drag
      overlay.classList.add('dragging');
      
      // Actualizar inmediatamente al inicio
      const percent = getPercentFromEvent(e);
      updateSlider(percent, true);
    }

    function drag(e) {
      if (!isDragging) return;
      e.preventDefault();
      
      const percent = getPercentFromEvent(e);
      updateSlider(percent);
    }

    function endDrag(e) {
      isDragging = false;
      needsRectUpdate = true;
      e.preventDefault();
      e.stopPropagation();
      
      // Restaurar selecci√≥n de texto
      document.body.style.userSelect = '';
      document.body.style.cursor = '';
      
      // Asegurar renderizado final
      if (rafId !== null) {
        cancelAnimationFrame(rafId);
        rafId = null;
      }
      updateSlider(currentPercent, true);
      
      // Reactivar transiciones despu√©s del drag
      overlay.classList.remove('dragging');
    }

    // Actualizar rect cuando la ventana cambia de tama√±o o se hace scroll
    function invalidateRect() {
      needsRectUpdate = true;
    }
    
    window.addEventListener('resize', invalidateRect);
    window.addEventListener('scroll', invalidateRect, true);

    // Eventos del mouse
    handleIcon.addEventListener('mousedown', startDrag);
    wrapper.addEventListener('mousedown', function(e) {
      if (e.target !== handleIcon && !handleIcon.contains(e.target)) {
        startDrag(e);
        // startDrag ya actualiza el slider inmediatamente, no hace falta aqu√≠
      }
    });
    
    document.addEventListener('mousemove', drag);
    document.addEventListener('mouseup', endDrag);

    // Eventos t√°ctiles (touch)
    handleIcon.addEventListener('touchstart', startDrag, { passive: false });
    wrapper.addEventListener('touchstart', function(e) {
      if (e.target !== handleIcon && !handleIcon.contains(e.target)) {
        startDrag(e);
        // startDrag ya actualiza el slider inmediatamente, no hace falta aqu√≠
      }
    }, { passive: false });
    
    document.addEventListener('touchmove', drag, { passive: false });
    document.addEventListener('touchend', endDrag);
    document.addEventListener('touchcancel', endDrag);
  };
</script>


<body>

  <!-- MAPA DETR√ÅS -->
  <div id="map"></div>
  <div class="map-source fixed">Fuente: forest-fire.emergency.copernicus.eu/</div>

<!-- HEADER -->
<header id="topbar" role="banner" aria-label="Cabecera">
  <div id="brand">Miguel Ferreiro Garc√≠a</div>
  <div id="titleRight">¬øPor qu√© arden nuestros montes?</div>
</header>

<!-- SELECTOR DE CATEGOR√çAS -->
<div id="category-selector" class="category-selector">
    <div class="category-tabs" role="tablist" aria-label="Seleccionar categor√≠a de informaci√≥n">
        <button class="category-tab" role="tab" data-category="geologia" aria-pressed="false" tabindex="0">
            Geolog√≠a
        </button>
        <button class="category-tab" role="tab" data-category="vegetacion" aria-pressed="false" tabindex="-1">
            Vegetaci√≥n
        </button>
        <button class="category-tab" role="tab" data-category="clima" aria-pressed="false" tabindex="-1">
            Clima
        </button>
        <button class="category-tab" role="tab" data-category="geografia" aria-pressed="false" tabindex="-1">
            Geograf√≠a
        </button>
    </div>
</div>

<!-- Overlay para im√°genes de clima -->
<div id="climate-images-overlay" class="climate-images-overlay hidden">
    <div class="climate-images-container">
        <img id="larouco-clima-img" src="assets/Larouco_Clima.png" alt="Clima en Larouco" class="climate-img-large" />
        <img id="fases-clima-img" src="assets/Fases_Clima.png" alt="Fases del clima" class="climate-img-small" />
    </div>
</div>

  <!-- HERO DE APERTURA -->
  <section id="hero" aria-label="Portada">
    <div class="hero-inner">
      <h1 class="hero-headline">
        ¬øPor qu√© arden nuestros montes?
      </h1>
      <div class="hero-kicker">
        Un verano extremo, mucha vegetaci√≥n acumulada y un paisaje que ya no se comporta como antes.
        Con ayuda de los datos intentaremos entender por qu√© los incendios siguen golpeando con tanta fuerza al noroeste peninsular.
      </div>
    </div>
    <div class="scroll-hint">Desliza para explorar ‚Üì</div>
    <div class="photo-credit">FOTO: Pedro Armestre</div>
</section>


  <!-- STORYMAP -->
  <div id="story"></div>

  <script src="./config.js"></script>
  <script>
    // ==== Construcci√≥n DOM del storytelling (plantilla Mapbox) ====
    var layerTypes = {
      'fill': ['fill-opacity'],
      'line': ['line-opacity'],
      'circle': ['circle-opacity','circle-stroke-opacity'],
      'symbol': ['icon-opacity','text-opacity'],
      'raster': ['raster-opacity'],
      'fill-extrusion': ['fill-extrusion-opacity'],
      'heatmap': ['heatmap-opacity']
    };
    var alignments = { left:'lefty', center:'centered', right:'righty', full:'fully' };
    var story = document.getElementById('story');
    var features = document.createElement('div'); features.id='features';

    // Un solo cap√≠tulo por ahora (el que ya tienes en config)
    config.chapters.forEach((record, idx) => {
      var container = document.createElement('div');
      var chapter = document.createElement('div');

      if (record.title){ var h3 = document.createElement('h3'); h3.textContent = record.title; chapter.appendChild(h3); }
      if (record.description){ var p = document.createElement('p'); p.innerHTML = record.description; chapter.appendChild(p); }

      container.id = record.id; container.classList.add('step'); if(idx===0) container.classList.add('active');
      chapter.classList.add(alignments[record.alignment] || 'righty');
      container.appendChild(chapter); features.appendChild(container);
    });
    story.appendChild(features);

    // ==== Mapa ====
    mapboxgl.accessToken = config.accessToken;
    var map = new mapboxgl.Map({
      container: 'map',
      style: config.style,
      center: config.chapters[0].location.center,
      zoom: config.chapters[0].location.zoom,
      bearing: config.chapters[0].location.bearing,
      pitch: config.chapters[0].location.pitch,
      interactive: true
    });

    // ==== Scrollama ====
    var scroller = scrollama();

    function getLayerPaintType(layer){ return layerTypes[ map.getLayer(layer).type ]; }
    function setLayerOpacity(entry){
      var props = getLayerPaintType(entry.layer);
      props.forEach(function(prop){
        var opts = {};
        if(entry.duration){
          var tprop = prop + '-transition';
          opts = {duration: entry.duration};
          map.setPaintProperty(entry.layer, tprop, opts);
        }
        map.setPaintProperty(entry.layer, prop, entry.opacity, opts);
      });
    }

    map.on('load', function(){
      // Ocultar capas por defecto al cargar el mapa
      window.hideDefaultLayers();
      
      // Asegurar limpieza completa inicial
      CategoryController.hideAll();
      
      // Arrancamos el scroll cuando el mapa est√© listo, usando la funci√≥n que maneja callbacks
      window.enableChapterCallbacks(scroller, config, setLayerOpacity);
    });

    // ==== CONTROLADOR DE CATEGOR√çAS ====
    
    // Utilidades para manejo de visibilidad
    const CategoryController = {
        
        // Pre-carga de im√°genes
        preloadImages() {
            const images = ['assets/Fases_Clima.png', 'assets/Larouco_Clima.png'];
            images.forEach(src => {
                const img = new Image();
                img.src = src;
            });
        },

        // Oculta todas las capas y overlays con verificaci√≥n robusta
        hideAll() {
            const layersToHide = ['XEOURENSE', 'USOURENSE', 'RELIEVE'];
            
            layersToHide.forEach(layerId => {
                try {
                    if (map && map.isStyleLoaded && map.isStyleLoaded() && map.getLayer && map.getLayer(layerId)) {
                        // Verificar si la capa est√° visible antes de cambiarla
                        const visibility = map.getLayoutProperty(layerId, 'visibility');
                        if (visibility !== 'none') {
                            map.setLayoutProperty(layerId, 'visibility', 'none');
                        }
                    }
                } catch (error) {
                    console.warn(`Error ocultando capa ${layerId}:`, error);
                }
            });

            // Tambi√©n asegurar que las capas de fuego est√©n ocultas
            const fireLayerIds = ['FIRES_GLOW_POINT_1', 'FIRES_GLOW_POINT_2', 'FIRES_GLOW_POINT_3', 'FIRES_PERIMETER'];
            fireLayerIds.forEach(layerId => {
                try {
                    if (map && map.isStyleLoaded && map.isStyleLoaded() && map.getLayer && map.getLayer(layerId)) {
                        const props = getLayerPaintType(layerId);
                        props.forEach(prop => {
                            map.setPaintProperty(layerId, prop, 0, { duration: 0 });
                        });
                    }
                } catch (error) {
                    console.warn(`Error ocultando capa de fuego ${layerId}:`, error);
                }
            });

            // Ocultar overlays
            const climateOverlay = document.getElementById('climate-images-overlay');
            if (climateOverlay) {
                climateOverlay.classList.add('hidden');
            }
            
            // Ocultar marcador de Larouco
            window.hideLarouco();
        },

        // Muestra las im√°genes de clima
        showImagesForClima() {
            const climateOverlay = document.getElementById('climate-images-overlay');
            if (climateOverlay) {
                climateOverlay.classList.remove('hidden');
            }
        },

        // Versi√≥n segura para mostrar capas
        showLayerSafe(layerId, retries = 3) {
            try {
                if (map && map.getLayer && map.getLayer(layerId)) {
                    map.setLayoutProperty(layerId, 'visibility', 'visible');
                } else if (retries > 0) {
                    // Reintentar si la capa no est√° disponible
                    setTimeout(() => {
                        this.showLayerSafe(layerId, retries - 1);
                    }, 100);
                }
            } catch (error) {
                console.warn(`Error mostrando capa ${layerId}:`, error);
                if (retries > 0) {
                    setTimeout(() => {
                        this.showLayerSafe(layerId, retries - 1);
                    }, 200);
                }
            }
        },

        // Verifica si el mapa est√° listo con m√∫ltiples checks
        isMapReady() {
            return map && 
                   map.isStyleLoaded && 
                   map.isStyleLoaded() && 
                   map.loaded && 
                   map.loaded();
        }
    };

    // Estado actual del selector
    let currentCategory = null;

    // Contenido de cada categor√≠a (placeholders)
    const categoryContent = {
        geologia: {
    title: 'Geolog√≠a',
    text: '<h2>Geolog√≠a</h2>En esta capa podemos ver la <strong>litolog√≠a</strong> del sureste de Galicia. La mayor parte del territorio est√° compuesta por <strong>rocas metam√≥rficas</strong> y <strong>gran√≠ticas</strong>, que dan lugar a <strong>suelos √°cidos</strong>.<br>Estos suelos favorecen comunidades de plantas m√°s <strong>inflamables</strong>, debido a la composici√≥n de sus tejidos.<br><br><strong>Leyenda:</strong><br><span style="color: #e7298a;">‚ñ†</span> DEP√ìSITOS DETR√çTICOS CUATERNARIOS<br><span style="color: #1b9e77;">‚ñ†</span> DEP√ìSITOS DETR√çTICOS TERCIARIOS<br><span style="color: #e6ab02;">‚ñ†</span> DEP√ìSITOS PLIOCUATERNARIOS<br><span style="color: #8cf0b7;">‚ñ†</span> ROCAS CARBONATADAS<br><span style="color: #51e723;">‚ñ†</span> ROCAS FILONIANAS<br><span style="color: #d95f02;">‚ñ†</span> ROCAS GRAN√çTICAS<br><span style="color: #7570b3;">‚ñ†</span> ROCAS METAM√ìRFICAS<br><br><div style="text-align: right; font-style: italic; color: #666; font-size: 12px;">Fuente: SERGAS</div>'
},

        vegetacion: {
    title: 'Vegetaci√≥n',
    text: '<h2>Vegetaci√≥n</h2>Esta capa muestra los <strong>usos del suelo</strong> en el sureste de Galicia. Destaca el claro predominio del <strong>matorral</strong>, muy por encima de otros usos como el <strong>mosaico agroforestal</strong>, las <strong>zonas de cultivo</strong> o los peque√±os <strong>bosques</strong> y <strong>plantaciones forestales</strong>. Esta distribuci√≥n es clave para entender la cantidad y la continuidad del <strong>combustible vegetal</strong>, factores decisivos en la propagaci√≥n de los incendios.<br><br><strong>Leyenda:</strong><br><span style="color: #a6cee3;">‚ñ†</span> MOSAICO AGROFORESTAL<br><span style="color: #1f78b4;">‚ñ†</span> TURBERA<br><span style="color: #b2df8a;">‚ñ†</span> PLANTACI√ìN FORESTAL<br><span style="color: #33a02c;">‚ñ†</span> BOSQUE<br><span style="color: #fb9a99;">‚ñ†</span> AGROSISTEMA EXTENSIVO<br><span style="color: #e31a1c;">‚ñ†</span> SUPERFICIE DE CULTIVO<br><span style="color: #fdbf6f;">‚ñ†</span> MATORRAL Y ROCAS<br><span style="color: #ff7f00;">‚ñ†</span> EXTRACTIVO<br><span style="color: #cab2d6;">‚ñ†</span> VI√ëEDO<br><br><div style="text-align: right; font-style: italic; color: #666; font-size: 12px;">Fuente: SERGAS</div>'
},

        clima: {
    title: 'Clima',
    text: '<h2>Clima</h2>Este gr√°fico muestra las <strong>precipitaciones</strong>, la <strong>temperatura</strong> y el <strong>NDVI</strong> (un √≠ndice que mide la actividad de la vegetaci√≥n) registrados en la estaci√≥n de <strong>Larouco</strong>, en la zona del incendio.<br><br>Se observan dos fases bien definidas:<br><br>üåß <strong>Estaci√≥n lluviosa</strong>: abundantes lluvias y temperaturas moderadas reducen el riesgo de incendio mientras favorecen una alta productividad vegetal y la acumulaci√≥n de biomasa.<br><br>‚òÄÔ∏è <strong>Estaci√≥n seca</strong>: con el aumento prolongado de las temperaturas se aprecia una ca√≠da del <strong>NDVI</strong> ‚Äîla vegetaci√≥n se seca‚Äî, la reserva de combustible es elevada y el riesgo de incendio se dispara.<br><br>Este patr√≥n encaja con <strong>climas mediterr√°neo lluvioso</strong>, <strong>tropical estacional</strong> o ciertos <strong>climas continentales</strong>, donde el fuego es parte de la din√°mica natural del ecosistema.'
},

        geografia: {
    title: 'Geograf√≠a',
    text: '<h2>Geograf√≠a</h2>En el mapa se aprecia un <strong>relieve monta√±oso y muy recortado</strong>, con valles profundos y laderas escarpadas que caracterizan buena parte del interior de Galicia.<br><br>La <strong>geograf√≠a</strong> influye de forma decisiva en el comportamiento del fuego:<br><br><strong>Relieve abrupto</strong>: las pendientes dificultan el acceso de los equipos de extinci√≥n y facilitan que las llamas asciendan con rapidez.<br><br><strong>Vientos irregulares y fuertes</strong>: en zonas monta√±osas las corrientes de aire cambian de direcci√≥n con facilidad, lo que puede desviar bruscamente el avance del incendio.'
}

    };

    // Funci√≥n para actualizar la explicaci√≥n de la capa
    function updateLayerExplanation(categoryKey) {
        const descriptionElement = document.getElementById('layer-description');
        
        if (descriptionElement) {
            if (categoryContent && categoryContent[categoryKey]) {
                descriptionElement.innerHTML = categoryContent[categoryKey].text;
            } else {
                descriptionElement.innerHTML = 'Selecciona una categor√≠a para conocer c√≥mo influye en la propagaci√≥n del fuego.';
            }
        }
    }

    // Controlador principal de categor√≠as
    function setCategory(category) {
        // Prevenir m√∫ltiples ejecuciones simult√°neas
        if (setCategory.isProcessing) {
            return;
        }
        setCategory.isProcessing = true;
        
        try {
            // Si el mapa no est√° listo, esperar
            if (!CategoryController.isMapReady()) {
                map.once('idle', () => {
                    setCategory.isProcessing = false;
                    setCategory(category);
                });
                return;
            }

            // Siempre ocultar todo primero
            CategoryController.hideAll();
            
            // Actualizar inmediatamente estado visual de botones y explicaci√≥n
            updateCategoryButtons(category);
            updateLayerExplanation(category);
            
            // Peque√±a pausa para asegurar que las capas se oculten antes de mostrar nuevas
            setTimeout(() => {
                // Mostrar contenido seg√∫n categor√≠a con verificaci√≥n adicional
                switch(category) {
                    case 'geologia':
                        CategoryController.showLayerSafe('XEOURENSE');
                        break;
                        
                    case 'vegetacion':
                        CategoryController.showLayerSafe('USOURENSE');
                        break;
                        
                    case 'clima':
                        CategoryController.showImagesForClima();
                        break;
                        
                    case 'geografia':
                        CategoryController.showLayerSafe('RELIEVE');
                        break;
                }
                
                currentCategory = category;
                setCategory.isProcessing = false;
            }, 50);
            
        } catch (error) {
            console.error('Error en setCategory:', error);
            setCategory.isProcessing = false;
        }
    }

    // Actualiza el estado visual de los botones
    function updateCategoryButtons(activeCategory) {
        const buttons = document.querySelectorAll('.category-tab');
        
        buttons.forEach((button, index) => {
            const category = button.getAttribute('data-category');
            const isActive = category === activeCategory;
            
            button.setAttribute('aria-pressed', isActive.toString());
            button.setAttribute('tabindex', isActive ? '0' : '-1');
        });
    }

    // Navegaci√≥n con teclado entre categor√≠as
    function navigateCategories(direction) {
        const buttons = Array.from(document.querySelectorAll('.category-tab'));
        const currentIndex = buttons.findIndex(btn => btn.getAttribute('aria-pressed') === 'true');
        const nextIndex = Math.max(0, Math.min(buttons.length - 1, currentIndex + direction));
        
        if (nextIndex !== currentIndex) {
            buttons[nextIndex].focus();
            const category = buttons[nextIndex].getAttribute('data-category');
            setCategory(category);
        }
    }

    // Inicializar eventos del selector
    function initCategorySelector() {
        CategoryController.preloadImages();
        
        const buttons = document.querySelectorAll('.category-tab');
        
        buttons.forEach(button => {
            // Click events simplificados - sin debounce problem√°tico
            button.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // Solo procesar si no est√° ya procesando
                if (!setCategory.isProcessing) {
                    const category = button.getAttribute('data-category');
                    setCategory(category);
                }
            });
            
            // Prevenir doble click
            button.addEventListener('dblclick', (e) => {
                e.preventDefault();
                e.stopPropagation();
            });
            
            // Keyboard events
            button.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const category = button.getAttribute('data-category');
                    setCategory(category);
                }
                
                // Arrow navigation
                if (e.key === 'ArrowLeft' || e.key === 'ArrowRight') {
                    e.preventDefault();
                    navigateCategories(e.key === 'ArrowRight' ? 1 : -1);
                }
            });
        });

        // El contenedor de clima ya no necesita click fuera para cerrarse
        // Se cierra autom√°ticamente al cambiar de categor√≠a
    }

    // Callbacks para integraci√≥n con cap√≠tulos
    window.showCategorySelector = function() {
        const selector = document.getElementById('category-selector');
        if (selector) {
            selector.style.display = 'flex';
        }
    };

    window.hideCategorySelector = function() {
        // Forzar limpieza completa
        CategoryController.hideAll();
        updateCategoryButtons(null);
        updateLayerExplanation(null);
        currentCategory = null;
        
        // Detener cualquier procesamiento del selector de categor√≠as
        if (setCategory.isProcessing) {
            setCategory.isProcessing = false;
        }
        
        const selector = document.getElementById('category-selector');
        if (selector) {
            selector.style.display = 'none';
        }
        
        // Asegurar que todas las capas problem√°ticas est√©n ocultas
        ['XEOURENSE', 'USOURENSE', 'RELIEVE', 'FIRES_GLOW_POINT_1', 'FIRES_GLOW_POINT_2', 'FIRES_GLOW_POINT_3', 'FIRES_PERIMETER'].forEach(layerId => {
            try {
                if (map && map.isStyleLoaded && map.isStyleLoaded() && map.getLayer && map.getLayer(layerId)) {
                    if (layerId.startsWith('FIRES_')) {
                        const props = getLayerPaintType(layerId);
                        props.forEach(prop => {
                            map.setPaintProperty(layerId, prop, 0, { duration: 0 });
                        });
                    } else {
                        map.setLayoutProperty(layerId, 'visibility', 'none');
                    }
                }
            } catch (error) {
                console.warn(`Error en limpieza forzada de capa ${layerId}:`, error);
            }
        });
        
        // Ocultar marcador
        window.hideLarouco();
    };

    // Auto-inicializar cuando el DOM est√© listo
    document.addEventListener('DOMContentLoaded', initCategorySelector);
  </script>
  <!-- HERO FINAL (fuera de Scrollama) -->
  <section id="hero-final" aria-label="Cierre">
    <div class="hero-inner">
      <h1 class="hero-headline">
        Debemos aprender a convivir con el fuego, pero podemos hacer m√°s‚Ä¶
      </h1>
      <div class="hero-kicker" style="text-align:left">
        Pero me temo que no hay tal varita m√°gica. Hay que aceptar que el fuego seguir√° formando parte de la realidad, cada vez m√°s con el cambio clim√°tico.<br><br>
        La prioridad: reducir su impacto y adaptarnos, m√°s que buscar culpables f√°ciles.<br><br>
        La respuesta es compleja, y requiere visi√≥n a largo plazo: m√°s gesti√≥n del paisaje, m√°s pastoreo adaptativo, prevenci√≥n activa en la interfaz urbano-forestal, educaci√≥n para la convivencia con el fuego‚Ä¶ y mucho m√°s.<br><br>
        El fuego es un fen√≥meno natural: frecuentemente negativo y tr√°gico para personas, bienes y modos de vida, pero a menudo positivo para el rejuvenecimiento y la din√°mica de los ecosistemas.<br><br>
        Entenderlo es clave para aprender a convivir con √©l.
      </div>
    </div>
    <div class="photo-credit">FOTO: Pedro Armestre</div>
  </section>
</body>
</html>

